// entry/src/main/ets/view/Mine.ets (æˆ–å…¶ä»– Mine.ets æ‰€åœ¨è·¯å¾„)

import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { tokenManager } from '../utils/TokenManager';
import { apiService } from '../api/ApiService';
import { preferences } from '@kit.ArkData';

// ç”¨æˆ·ä¿¡æ¯æ¥å£
interface UserInfo {
  nickname: string;
  avatar: string;
  level: number;
  coins: number;
  followers: number;
  following: number;
}

// Bç«™é‰´æƒä¿¡æ¯æ¥å£
interface BilibiliAuthInfo {
  nickname: string;
  avatar: string;
  dedeuserid: string;
}

// ç»Ÿè®¡æ•°æ®æ¥å£
interface StatsItem {
  title: string;
  value: string;
  icon: string;
  color: string;
}

// èœå•é¡¹æ¥å£
interface MenuItem {
  icon: string;
  title: string;
  subtitle: string;
  color: string;
}

@Component
export struct Mine {
  @State isLoggingOut: boolean = false; // æ·»åŠ çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
  @State isLoading: boolean = true; // æ•°æ®åŠ è½½çŠ¶æ€
  @State userToken: string = ''; // ç”¨æˆ·token
  @State bilibiliAuthInfo: BilibiliAuthInfo | null = null; // Bç«™é‰´æƒä¿¡æ¯
  @State userInfo: UserInfo = {
    nickname: 'Bç«™ç”¨æˆ·',
    avatar: 'https://i0.hdslb.com/bfs/face/84f1e4b0dd26cc45bb268275e68747cf9e8ba334.jpg',
    level: 6,
    coins: 1234,
    followers: 567,
    following: 89
  };
  @State realUserStats: StatsItem[] = [
    { title: 'è§‚çœ‹å†å²', value: '0', icon: 'ğŸ“º', color: '#FF6B9D' },
    { title: 'æ”¶è—å¤¹', value: '0', icon: 'â­', color: '#4ECDC4' },
    { title: 'ç‚¹èµæ•°', value: '0', icon: 'ğŸ‘', color: '#45B7D1' },
    { title: 'æŠ•å¸æ•°', value: '0', icon: 'ğŸª™', color: '#FFEAA7' }
  ];
  @State statsData: Array<StatsItem> = [
    { title: 'è§‚çœ‹å†å²', value: '128', icon: 'ğŸ“º', color: '#FF6B9D' },
    { title: 'æ”¶è—å¤¹', value: '45', icon: 'â­', color: '#4ECDC4' },
    { title: 'ç‚¹èµæ•°', value: '892', icon: 'ğŸ‘', color: '#45B7D1' },
    { title: 'æŠ•å¸æ•°', value: '234', icon: 'ğŸª™', color: '#FFEAA7' }
  ];

  // åŠŸèƒ½èœå•æ•°æ®
  private menuData: Array<MenuItem> = [
    { icon: 'ğŸ“±', title: 'æˆ‘çš„è®¾å¤‡', subtitle: 'ç®¡ç†ç™»å½•è®¾å¤‡', color: '#FF6B9D' },
    { icon: 'ğŸ””', title: 'æ¶ˆæ¯é€šçŸ¥', subtitle: 'æ¨é€è®¾ç½®', color: '#4ECDC4' },
    { icon: 'ğŸ¨', title: 'ä¸ªæ€§è£…æ‰®', subtitle: 'ä¸»é¢˜çš®è‚¤', color: '#45B7D1' },
    { icon: 'ğŸ’°', title: 'é’±åŒ…', subtitle: 'ä½™é¢å……å€¼', color: '#96CEB4' },
    { icon: 'ğŸ', title: 'ä¼šå‘˜ä¸­å¿ƒ', subtitle: 'ç‰¹æƒæœåŠ¡', color: '#FFEAA7' },
    { icon: 'ğŸ“Š', title: 'æ•°æ®ç»Ÿè®¡', subtitle: 'è§‚çœ‹åˆ†æ', color: '#DDA0DD' },
    { icon: 'âš™ï¸', title: 'è®¾ç½®', subtitle: 'è´¦å·å®‰å…¨', color: '#FFB6C1' },
    { icon: 'â“', title: 'å¸®åŠ©åé¦ˆ', subtitle: 'æ„è§å»ºè®®', color: '#87CEEB' }
  ];

  // è·å– UIAbility ä¸Šä¸‹æ–‡
  private getUIAbilityContext(): common.UIAbilityContext {
    return AppStorage.get('uiAbilityContext') as common.UIAbilityContext;
  }

  // ç»„ä»¶å³å°†å‡ºç°æ—¶è°ƒç”¨
  async aboutToAppear() {
    await this.loadUserData();
  }

  // åŠ è½½ç”¨æˆ·æ•°æ®
  async loadUserData(): Promise<void> {
    try {
      this.isLoading = true;
      const context = this.getUIAbilityContext();
      
      // è·å–ç”¨æˆ·token
      this.userToken = await tokenManager.getToken(context) || '';
      
      if (this.userToken) {
        // è·å–Bç«™é‰´æƒä¿¡æ¯
        await this.loadBilibiliAuthInfo();
        // è·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®
        await this.loadUserStats();
      }
    } catch (error) {
      console.error('âŒ åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // è·å–Bç«™é‰´æƒä¿¡æ¯
  async loadBilibiliAuthInfo(): Promise<void> {
    try {
      if (!this.userToken) {
        console.warn('âš ï¸ ç”¨æˆ·tokenä¸ºç©ºï¼Œæ— æ³•è·å–å“”å“©å“”å“©é‰´æƒä¿¡æ¯');
        return;
      }

      console.log('ğŸ”„ å¼€å§‹è·å–å“”å“©å“”å“©é‰´æƒä¿¡æ¯...');
      const authInfo = await apiService.getBilibiliAuthInfo(this.userToken);
      
      if (authInfo && authInfo.cookies && authInfo.cookies.SESSDATA) {
        this.bilibiliAuthInfo = {
          nickname: authInfo.nickname || 'æœªçŸ¥ç”¨æˆ·',
          avatar: authInfo.avatar || '',
          dedeuserid: authInfo.dedeuserid || ''
        };
        
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        this.userInfo = {
          nickname: authInfo.nickname || 'Bç«™ç”¨æˆ·',
          avatar: authInfo.avatar || this.userInfo.avatar,
          level: this.userInfo.level,
          coins: this.userInfo.coins,
          followers: this.userInfo.followers,
          following: this.userInfo.following
        };
        
        console.log('âœ… è·å–å“”å“©å“”å“©é‰´æƒä¿¡æ¯æˆåŠŸ');
      }
    } catch (error) {
      console.error('âŒ è·å–å“”å“©å“”å“©é‰´æƒä¿¡æ¯å¤±è´¥:', error);
    }
  }

  // è·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®
  async loadUserStats(): Promise<void> {
    try {
      // è¿™é‡Œå¯ä»¥è°ƒç”¨APIè·å–çœŸå®çš„ç”¨æˆ·ç»Ÿè®¡æ•°æ®
      // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œå¯ä»¥æ ¹æ®å®é™…APIè¿›è¡Œè°ƒæ•´
      const historyCount = Math.floor(Math.random() * 500) + 100;
      const favoritesCount = Math.floor(Math.random() * 100) + 20;
      const likesCount = Math.floor(Math.random() * 1000) + 200;
      const coinsCount = Math.floor(Math.random() * 500) + 50;
      
      this.realUserStats = [
        { title: 'è§‚çœ‹å†å²', value: historyCount.toString(), icon: 'ğŸ“º', color: '#FF6B9D' },
        { title: 'æ”¶è—å¤¹', value: favoritesCount.toString(), icon: 'â­', color: '#4ECDC4' },
        { title: 'ç‚¹èµæ•°', value: likesCount.toString(), icon: 'ğŸ‘', color: '#45B7D1' },
        { title: 'æŠ•å¸æ•°', value: coinsCount.toString(), icon: 'ğŸª™', color: '#FFEAA7' }
      ];
      
      // æ›´æ–°ç¡¬å¸æ•°é‡
      this.userInfo.coins = coinsCount;
      
      console.log('âœ… ç”¨æˆ·ç»Ÿè®¡æ•°æ®åŠ è½½å®Œæˆ');
    } catch (error) {
      console.error('âŒ è·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    }
  }

  // å¤„ç†é€€å‡ºç™»å½•çš„å‡½æ•°
  async handleLogout() {
    if (this.isLoggingOut) {
      return;
    }
    this.isLoggingOut = true;

    const context = this.getUIAbilityContext();
    const token = await tokenManager.getToken(context);

    try {
      if (token) {
        // 1. è°ƒç”¨åç«¯APIï¼Œé€šçŸ¥æœåŠ¡å™¨ç”¨æˆ·ç™»å‡º
        await apiService.logout(token);
      }
    } catch (error) {
      const err = error as Error;
      // å³ä¾¿åç«¯APIè°ƒç”¨å¤±è´¥ï¼ˆæ¯”å¦‚ç½‘ç»œé—®é¢˜æˆ–tokenå·²è¿‡æœŸï¼‰ï¼Œå®¢æˆ·ç«¯ä¹Ÿåº”ç»§ç»­æ‰§è¡Œç™»å‡ºæµç¨‹
      console.error(`Logout API call failed: ${err.message}`);
    } finally {
      // 2. æ— è®ºAPIè°ƒç”¨æˆåŠŸä¸å¦ï¼Œéƒ½å¿…é¡»æ¸…é™¤æœ¬åœ°Token
      await tokenManager.deleteToken(context);

      // 3. æç¤ºç”¨æˆ·å¹¶é‡å®šå‘åˆ°ç™»å½•é¡µ
      promptAction.showToast({ message: 'æ‚¨å·²æˆåŠŸé€€å‡º' });

      // ä½¿ç”¨ replaceUrl è·³è½¬ï¼Œè¿™æ ·ç”¨æˆ·æ— æ³•æŒ‰è¿”å›é”®å›åˆ°"æˆ‘çš„"é¡µé¢
      router.replaceUrl({ url: 'pages/LoginPage' });

      this.isLoggingOut = false;
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildHeader()
      
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 16 }) {
          // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
          this.buildUserCard()
          
          // æ•°æ®ç»Ÿè®¡å¡ç‰‡
          this.buildStatsCard()
          
          // åŠŸèƒ½èœå•
          this.buildMenuGrid()
          
          // ä¼šå‘˜ç‰¹æƒæ¨ªå¹…
          this.buildVipBanner()
          
          // é€€å‡ºç™»å½•æŒ‰é’®
          this.buildLogoutButton()
          
          // åº•éƒ¨é—´è·
          Blank().height(20)
        }
        .padding({ left: 16, right: 16 })
      }
      .scrollBar(BarState.Off)
      .backgroundColor('#F8F9FA')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }

  // æ„å»ºé¡¶éƒ¨å¯¼èˆªæ 
  @Builder
  buildHeader() {
    Row() {
      Text('æˆ‘çš„')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
      
      Blank()
      
      Row({ space: 16 }) {
        Text('ğŸ”')
          .fontSize(20)
          .onClick(() => {
            // æœç´¢åŠŸèƒ½
          })
        
        Text('âš™ï¸')
          .fontSize(20)
          .onClick(() => {
            // è®¾ç½®åŠŸèƒ½
          })
      }
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#FFFFFF')
    .shadow({ radius: 2, color: '#1A000000', offsetY: 1 })
  }

  // æ„å»ºç”¨æˆ·ä¿¡æ¯å¡ç‰‡
  @Builder
  buildUserCard() {
    Row({ space: 16 }) {
      // å¤´åƒ
      Stack() {
        if (this.isLoading) {
          // åŠ è½½çŠ¶æ€çš„å ä½ç¬¦
          Column()
            .width(80)
            .height(80)
            .borderRadius(40)
            .backgroundColor('#F0F0F0')
            .animation({ duration: 1000, iterations: -1 })
        } else {
          Image(this.bilibiliAuthInfo?.avatar || this.userInfo.avatar)
            .width(80)
            .height(80)
            .borderRadius(40)
            .objectFit(ImageFit.Cover)
            .alt($r('app.media.photo35'))
        }
        
        // ç­‰çº§æ ‡è¯†
        Text(`LV${this.userInfo.level}`)
          .fontSize(10)
          .fontColor('#FFFFFF')
          .backgroundColor('#FF6B9D')
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .borderRadius(8)
          .position({ x: 55, y: 60 })
          .opacity(this.isLoading ? 0.5 : 1)
      }
      
      // ç”¨æˆ·ä¿¡æ¯
      Column({ space: 8 }) {
        if (this.isLoading) {
          // åŠ è½½çŠ¶æ€
          Column()
            .width(120)
            .height(20)
            .backgroundColor('#F0F0F0')
            .borderRadius(4)
        } else {
          Text(this.bilibiliAuthInfo?.nickname || this.userInfo.nickname)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        
        if (this.bilibiliAuthInfo?.dedeuserid && !this.isLoading) {
          Text(`UID: ${this.bilibiliAuthInfo.dedeuserid}`)
            .fontSize(12)
            .fontColor('#666666')
        }
        
        Text(this.isLoading ? 'åŠ è½½ä¸­...' : 'å“”å“©å“”å“©ç”¨æˆ·')
          .fontSize(14)
          .fontColor('#999999')
        
        Row({ space: 16 }) {
          Column({ space: 2 }) {
            Text(this.isLoading ? '--' : this.userInfo.coins.toString())
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#FF6B9D')
            Text('ç¡¬å¸')
              .fontSize(12)
              .fontColor('#666666')
          }
          
          Column({ space: 2 }) {
            Text(this.isLoading ? '--' : this.userInfo.followers.toString())
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#4ECDC4')
            Text('ç²‰ä¸')
              .fontSize(12)
              .fontColor('#666666')
          }
          
          Column({ space: 2 }) {
            Text(this.userInfo.following.toString())
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#45B7D1')
            Text('å…³æ³¨')
              .fontSize(12)
              .fontColor('#666666')
          }
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      // ç¼–è¾‘æŒ‰é’®
      Text('âœï¸')
        .fontSize(20)
        .onClick(() => {
          // ç¼–è¾‘ä¸ªäººä¿¡æ¯
        })
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({ radius: 8, color: '#1A000000', offsetY: 4 })
    .margin({ top: 16 })
  }

  // æ„å»ºæ•°æ®ç»Ÿè®¡å¡ç‰‡
  @Builder
  buildStatsCard() {
    Column({ space: 12 }) {
      Row() {
        Text('æˆ‘çš„æ•°æ®')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
        
        Blank()
        
        Row({ space: 8 }) {
          if (this.isLoading) {
            Text('ğŸ”„')
              .fontSize(16)
              .fontColor('#FF6B9D')
              .animation({ duration: 1000, iterations: -1, curve: Curve.Linear })
              .rotate({ angle: this.isLoading ? 360 : 0 })
          } else {
            Text('ğŸ”„')
              .fontSize(16)
              .fontColor('#FF6B9D')
              .onClick(async () => {
                await this.loadUserData();
              })
          }
          
          Text('æŸ¥çœ‹è¯¦æƒ… >')
            .fontSize(14)
            .fontColor('#FF6B9D')
        }
      }
      .width('100%')
      
      Row({ space: 12 }) {
        ForEach(this.isLoading ? this.statsData : this.realUserStats, (item: StatsItem) => {
          Column({ space: 8 }) {
            Text(item.icon)
              .fontSize(24)
              .opacity(this.isLoading ? 0.5 : 1)
            if (this.isLoading) {
              Column()
                .width(40)
                .height(20)
                .backgroundColor('#F0F0F0')
                .borderRadius(4)
            } else {
              Text(item.value)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor(item.color)
            }
            Text(item.title)
              .fontSize(12)
              .fontColor('#666666')
              .opacity(this.isLoading ? 0.5 : 1)
          }
          .width('25%')
          .height(80)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .justifyContent(FlexAlign.Center)
          .shadow({ radius: 4, color: '#1A000000', offsetY: 2 })
          .onClick(() => {
            // ç‚¹å‡»ç»Ÿè®¡é¡¹
          })
        })
      }
      .width('100%')
    }
    .margin({ top: 16 })
  }

  // æ„å»ºåŠŸèƒ½èœå•ç½‘æ ¼
  @Builder
  buildMenuGrid() {
    Column({ space: 12 }) {
      Row() {
        Text('åŠŸèƒ½æœåŠ¡')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
      }
      .width('100%')
      
      Grid() {
        ForEach(this.menuData, (item: MenuItem) => {
          GridItem() {
            Row({ space: 12 }) {
              Text(item.icon)
                .fontSize(24)
                .width(40)
                .height(40)
                .textAlign(TextAlign.Center)
                .backgroundColor(item.color + '20')
                .borderRadius(20)
                .lineHeight(40)
              
              Column({ space: 4 }) {
                Text(item.title)
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                Text(item.subtitle)
                  .fontSize(12)
                  .fontColor('#666666')
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              Text('>')
                .fontSize(16)
                .fontColor('#CCCCCC')
            }
            .width('100%')
            .height(60)
            .padding({ left: 16, right: 16 })
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .shadow({ radius: 4, color: '#1A000000', offsetY: 2 })
            .onClick(() => {
              // åŠŸèƒ½ç‚¹å‡»äº‹ä»¶
              promptAction.showToast({ message: `ç‚¹å‡»äº†${item.title}` });
            })
          }
        })
      }
      .columnsTemplate('1fr')
      .rowsGap(8)
      .width('100%')
    }
    .margin({ top: 16 })
  }

  // æ„å»ºä¼šå‘˜ç‰¹æƒæ¨ªå¹…
  @Builder
  buildVipBanner() {
    Column({ space: 12 }) {
      Row({ space: 16 }) {
        Column({ space: 4 }) {
          Row({ space: 8 }) {
            Text('ğŸ‘‘')
              .fontSize(20)
            Text('å“”å“©å“”å“©å¤§ä¼šå‘˜')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FFFFFF')
          }
          Text('ä¸“å±ç‰¹æƒï¼Œç•…äº«æ— é™ç²¾å½©')
            .fontSize(12)
            .fontColor('#FFFFFF')
            .opacity(0.9)
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        
        Button(this.bilibiliAuthInfo ? 'ç»­è´¹ä¼šå‘˜' : 'ç«‹å³å¼€é€š')
          .width(80)
          .height(32)
          .fontSize(12)
          .backgroundColor('#FFFFFF')
          .fontColor('#FF6B9D')
          .borderRadius(16)
          .shadow({ radius: 4, color: '#1A000000', offsetY: 2 })
      }
      
      // ä¼šå‘˜ç‰¹æƒå±•ç¤º
      Row({ space: 20 }) {
        Column({ space: 4 }) {
          Text('ğŸ¬')
            .fontSize(16)
          Text('ä¸“å±å†…å®¹')
            .fontSize(10)
            .fontColor('#FFFFFF')
            .opacity(0.8)
        }
        
        Column({ space: 4 }) {
          Text('ğŸ“±')
            .fontSize(16)
          Text('å…å¹¿å‘Š')
            .fontSize(10)
            .fontColor('#FFFFFF')
            .opacity(0.8)
        }
        
        Column({ space: 4 }) {
          Text('âš¡')
            .fontSize(16)
          Text('é«˜æ¸…ç”»è´¨')
            .fontSize(10)
            .fontColor('#FFFFFF')
            .opacity(0.8)
        }
        
        Column({ space: 4 }) {
          Text('ğŸ')
            .fontSize(16)
          Text('ä¸“å±ç¦åˆ©')
            .fontSize(10)
            .fontColor('#FFFFFF')
            .opacity(0.8)
        }
      }
      .justifyContent(FlexAlign.SpaceAround)
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FF6B9D')
    .borderRadius(16)
    .linearGradient({
      direction: GradientDirection.Right,
      colors: [['#FF6B9D', 0.0], ['#4ECDC4', 1.0]]
    })
    .shadow({ radius: 8, color: '#1A000000', offsetY: 4 })
    .margin({ top: 16 })
    .onClick(() => {
      // å¼€é€šä¼šå‘˜
    })
  }

  // æ„å»ºé€€å‡ºç™»å½•æŒ‰é’®
  @Builder
  buildLogoutButton() {
    Button(this.isLoggingOut ? 'æ­£åœ¨é€€å‡º...' : 'é€€å‡ºç™»å½•')
      .width('100%')
      .height(48)
      .fontSize(16)
      .fontColor('#FF4757')
      .backgroundColor('#FFFFFF')
      .border({ width: 1, color: '#FF4757', radius: 24 })
      .enabled(!this.isLoggingOut)
      .margin({ top: 24 })
      .onClick(() => {
        this.handleLogout();
      })
  }
}