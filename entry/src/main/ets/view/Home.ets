import { MyDataSource } from '../Model/MyDataSource';
import { VideoData } from '../Model/VideoData';
import { requestSelf } from '../api/bliblihome'; // ç¡®ä¿è·¯å¾„æ­£ç¡®
import http from '@ohos.net.http';
import { promptAction, router } from '@kit.ArkUI';
import { apiService } from '../api/ApiService';
import { preferences } from '@kit.ArkData';
import { tokenManager } from '../utils/TokenManager';
import { common } from '@kit.AbilityKit';

// å®šä¹‰è§†é¢‘ä¿¡æ¯æ¥å£
interface VideoInfo {
  bvid: string;
  name: string;
  description: string;
  pic: string;
  view: number;
  danmaku: number;
  duration: number;
  tname: string;
}

// å®šä¹‰Bç«™é‰´æƒä¿¡æ¯æ¥å£
interface BilibiliAuthInfo {
  nickname: string;
  avatar: string;
  dedeuserid: string;
}

// å®šä¹‰ç”¨æˆ·ä¿¡æ¯æ¥å£
interface UserInfo {
  name?: string;
  email?: string;
}

// å®šä¹‰è§†é¢‘æ‰€æœ‰è€…æ¥å£
interface VideoOwner {
  name: string;
  face: string;
  mid: number;
}

// å®šä¹‰è§†é¢‘ç»Ÿè®¡æ¥å£
interface VideoStat {
  view: number;
  danmaku: number;
  reply: number;
  favorite: number;
  coin: number;
  share: number;
  like: number;
}

// å®šä¹‰è§†é¢‘é¡¹æ¥å£
interface BilibiliVideo {
  bvid: string;
  aid: number;
  cid: number;
  title: string;
  pic: string;
  desc: string;
  duration: number;
  pubdate: number;
  owner: VideoOwner;
  stat: VideoStat;
  tname: string;
}

// å®šä¹‰APIå“åº”æ¥å£
interface BilibiliRecommendResponse {
  videos: Array<BilibiliVideo>;
  has_more: boolean;
}



/*
 *
 * 1. top: { anchor: "row3", align: VerticalAlign.Bottom }
anchor: "row3"ï¼šè¿™ä¸ªå‚æ•°æŒ‡æ˜äº†å½“å‰ç»„ä»¶çš„ä¸Šè¾¹ç¼˜å°†ä¸åä¸º row3 çš„ç»„ä»¶å¯¹é½ã€‚
align: VerticalAlign.Bottomï¼šå½“å‰ç»„ä»¶çš„ä¸Šè¾¹ç¼˜å°†å¯¹é½åˆ° row3 çš„åº•éƒ¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å‰ç»„ä»¶çš„é¡¶éƒ¨å°†ä½äº row3 çš„åº•éƒ¨ä½ç½®ã€‚
2. bottom: { anchor: "__container__", align: VerticalAlign.Bottom }
anchor: "__container__"ï¼šè¿™é‡Œä½¿ç”¨äº† __container__ ä½œä¸ºé”šç‚¹ï¼Œè¡¨ç¤ºå½“å‰ç»„ä»¶çš„åº•éƒ¨å°†ä¸å…¶çˆ¶å®¹å™¨çš„åº•éƒ¨å¯¹é½ã€‚
align: VerticalAlign.Bottomï¼šå½“å‰ç»„ä»¶çš„åº•éƒ¨å°†å¯¹é½åˆ°å®¹å™¨çš„åº•éƒ¨è¾¹ç¼˜ã€‚
3. left: { anchor: "__container__", align: HorizontalAlign.Start }
anchor: "__container__"ï¼šå½“å‰ç»„ä»¶çš„å·¦è¾¹ç¼˜å°†ä¸çˆ¶å®¹å™¨çš„å·¦è¾¹ç¼˜å¯¹é½ã€‚
align: HorizontalAlign.Startï¼šè¿™è¡¨ç¤ºå½“å‰ç»„ä»¶çš„å·¦è¾¹ç¼˜å°†å¯¹é½åˆ°å®¹å™¨çš„å·¦ä¾§å¼€å§‹ä½ç½®ã€‚
4. right: { anchor: "row1", align: HorizontalAlign.End }
anchor: "row1"ï¼šå½“å‰ç»„ä»¶çš„å³è¾¹ç¼˜å°†ä¸åä¸º row1 çš„ç»„ä»¶å¯¹é½ã€‚
align: HorizontalAlign.Endï¼šè¿™è¡¨ç¤ºå½“å‰ç»„ä»¶çš„å³è¾¹ç¼˜å°†å¯¹é½åˆ° row1 çš„å³è¾¹ç¼˜ã€‚
* */
@Entry
@Component
export struct Home {
  private myController: VideoController = new VideoController();
  private datas: MyDataSource = new MyDataSource();
  @State index: number = 0;
  @State apiResponse: object = []; // å­˜å‚¨åŸå§‹ API å“åº”
  @State loadingMore: boolean = false; // ç”¨äºæŒ‡ç¤ºæ˜¯å¦æ­£åœ¨åŠ è½½æ›´å¤šæ•°æ®
  @State bottomTabIndex: number = 1;
  @State message: string = 'Hello World';
  @State videoList: Array<VideoInfo> = [];
  @State isLoading: boolean = false;
  @State currentPage: number = 1;
  @State hasMore: boolean = true;
  @State bilibiliAuthInfo: BilibiliAuthInfo | null = null;
  @State userToken: string = '';
  @State isHistoryMode: boolean = true; // é»˜è®¤ä¸ºå†å²æ¨¡å¼
  @State historyVideos: Array<VideoData> = []; // å†å²è§†é¢‘æ•°æ®

  @Styles
  listCard() {
    .backgroundColor(Color.White)
    .height(72)
    .width("100%")
    .borderRadius(12)
  }

  private getUIAbilityContext(): common.UIAbilityContext {
    return AppStorage.get('uiAbilityContext') as common.UIAbilityContext;
  }

  async aboutToAppear() {
    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿UIAbilityContextå·²ç»è®¾ç½®å®Œæˆ
    setTimeout(async () => {
      await this.loadUserToken();
      // é¦–é¡µå§‹ç»ˆæ˜¾ç¤ºæ¨èå†…å®¹ï¼Œä¸æ ¹æ®æ¨¡å¼åŠ è½½ä¸åŒæ•°æ®
    }, 100);
  }

  async loadUserToken() {
    // ğŸ”¥ ä¼˜å…ˆæ£€æŸ¥AppStorageä¸­æ˜¯å¦æœ‰å·²éªŒè¯çš„token
    const verifiedToken = AppStorage.get('verifiedToken') as string;
    const tokenVerified = AppStorage.get('tokenVerified') as boolean;
    const userInfo = AppStorage.get('userInfo') as UserInfo;
    
    if (verifiedToken && tokenVerified) {
      console.log('ğŸ¯ å‘ç°å·²éªŒè¯çš„tokenï¼Œç›´æ¥ä½¿ç”¨');
      this.userToken = verifiedToken;
      console.log('âœ… ä½¿ç”¨å·²éªŒè¯çš„token:', verifiedToken.substring(0, 10) + '...');
      
      if (userInfo) {
        console.log('ğŸ“‹ ç”¨æˆ·ä¿¡æ¯:', userInfo.name, userInfo.email);
      }
      
      // ç›´æ¥å°è¯•åŠ è½½å“”å“©å“”å“©é‰´æƒä¿¡æ¯å’Œæ¨èè§†é¢‘
      try {
        await this.loadBilibiliAuthInfo();
        console.log('ğŸ‰ é‰´æƒä¿¡æ¯åŠ è½½æˆåŠŸï¼Œå°è¯•åŠ è½½æ¨èè§†é¢‘');
        await this.loadRecommendVideos();
      } catch (authError) {
        console.warn('âš ï¸ é‰´æƒä¿¡æ¯åŠ è½½å¤±è´¥ï¼Œä½†tokenæœ‰æ•ˆï¼Œç›´æ¥å°è¯•åŠ è½½æ¨èè§†é¢‘:', authError);
        await this.loadRecommendVideos();
      }
      return;
    }
    
    // å¦‚æœAppStorageä¸­æ²¡æœ‰å·²éªŒè¯çš„tokenï¼Œåˆ™ä½¿ç”¨åŸæœ‰é€»è¾‘
    console.log('ğŸ” AppStorageä¸­æ²¡æœ‰å·²éªŒè¯tokenï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–');
    
    let retryCount = 0;
    const maxRetries = 5;
    
    while (retryCount < maxRetries) {
      try {
        const context = this.getUIAbilityContext();
        if (!context) {
          console.warn(`ç¬¬${retryCount + 1}æ¬¡å°è¯•ï¼šæ— æ³•è·å–UIAbilityContextï¼Œç­‰å¾…é‡è¯•...`);
          retryCount++;
          if (retryCount < maxRetries) {
            await new Promise<void>(resolve => setTimeout(resolve, 200 * retryCount)); // é€’å¢å»¶è¿Ÿ
            continue;
          } else {
            console.error('å¤šæ¬¡å°è¯•åä»æ— æ³•è·å–UIAbilityContextï¼Œä½¿ç”¨å¤‡ç”¨æ–¹å¼åŠ è½½æ•°æ®');
            await this.loadData();
            return;
          }
        }
        
        console.log('æˆåŠŸè·å–UIAbilityContextï¼Œå¼€å§‹è·å–token');
        const token = await tokenManager.getToken(context);
        if (token) {
          this.userToken = token;
          console.log('âœ… æˆåŠŸè·å–ç”¨æˆ·token:', token.substring(0, 10) + '...');
          
          // å…ˆå°è¯•åŠ è½½å“”å“©å“”å“©é‰´æƒä¿¡æ¯
          try {
            await this.loadBilibiliAuthInfo();
            console.log('ğŸ‰ é‰´æƒä¿¡æ¯åŠ è½½æˆåŠŸï¼Œå°è¯•åŠ è½½æ¨èè§†é¢‘');
            await this.loadRecommendVideos();
          } catch (authError) {
            console.warn('âš ï¸ é‰´æƒä¿¡æ¯åŠ è½½å¤±è´¥ï¼Œä½†tokenæœ‰æ•ˆï¼Œç›´æ¥å°è¯•åŠ è½½æ¨èè§†é¢‘:', authError);
            await this.loadRecommendVideos();
          }
        } else {
          console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·tokenï¼Œä½¿ç”¨å¤‡ç”¨æ–¹å¼åŠ è½½æ•°æ®');
          await this.loadData();
        }
        break; // æˆåŠŸæ‰§è¡Œï¼Œè·³å‡ºå¾ªç¯
      } catch (error) {
        console.error(`ç¬¬${retryCount + 1}æ¬¡è·å–ç”¨æˆ·tokenå¤±è´¥:`, error);
        retryCount++;
        if (retryCount >= maxRetries) {
          console.error('å¤šæ¬¡å°è¯•åä»æ— æ³•è·å–tokenï¼Œä½¿ç”¨å¤‡ç”¨æ–¹å¼åŠ è½½æ•°æ®');
          await this.loadData();
        } else {
          await new Promise<void>(resolve => setTimeout(resolve, 200 * retryCount));
        }
      }
    }
  }

  async loadBilibiliAuthInfo(): Promise<void> {
    try {
      if (!this.userToken) {
        console.warn('âš ï¸ ç”¨æˆ·tokenä¸ºç©ºï¼Œæ— æ³•è·å–å“”å“©å“”å“©é‰´æƒä¿¡æ¯');
        return;
      }

      console.log('ğŸ”„ å¼€å§‹è·å–å“”å“©å“”å“©é‰´æƒä¿¡æ¯...');
      const authInfo = await apiService.getBilibiliAuthInfo(this.userToken);
      
      console.log('ğŸ“¥ APIè¿”å›çš„é‰´æƒä¿¡æ¯:', {
        nickname: authInfo?.nickname,
        dedeuserid: authInfo?.dedeuserid,
        avatar: authInfo?.avatar ? 'æœ‰å¤´åƒ' : 'æ— å¤´åƒ',
        hasCookies: !!authInfo?.cookies,
        hasSessdata: !!authInfo?.cookies?.SESSDATA,
        sessdataLength: authInfo?.cookies?.SESSDATA?.length || 0
      });
      
      // éªŒè¯è¿”å›çš„æ•°æ®å®Œæ•´æ€§
      if (authInfo && authInfo.cookies && authInfo.cookies.SESSDATA) {
        this.bilibiliAuthInfo = {
          nickname: authInfo.nickname || 'æœªçŸ¥ç”¨æˆ·',
          avatar: authInfo.avatar || '',
          dedeuserid: authInfo.dedeuserid || ''
        };
        console.log('âœ… è·å–å“”å“©å“”å“©é‰´æƒä¿¡æ¯æˆåŠŸ:', {
          nickname: authInfo.nickname,
          dedeuserid: authInfo.dedeuserid,
          hasValidSessdata: !!authInfo.cookies.SESSDATA,
          sessdataPreview: authInfo.cookies.SESSDATA.substring(0, 20) + '...'
        });
      } else {
        console.error('âŒ è·å–çš„é‰´æƒä¿¡æ¯ä¸å®Œæ•´:', {
          hasAuthInfo: !!authInfo,
          hasCookies: !!authInfo?.cookies,
          hasSessdata: !!authInfo?.cookies?.SESSDATA,
          rawData: authInfo
        });
        throw new Error('é‰´æƒä¿¡æ¯æ ¼å¼é”™è¯¯æˆ–ç¼ºå°‘SESSDATA');
      }
    } catch (error) {
      console.error('âŒ è·å–å“”å“©å“”å“©é‰´æƒä¿¡æ¯å¤±è´¥:', error);
      // æ¸…ç©ºé‰´æƒä¿¡æ¯
      this.bilibiliAuthInfo = null;
      throw new Error(error instanceof Error ? error.message : String(error)); // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨æ–¹çŸ¥é“å¤±è´¥äº†
    }
  }

  async loadRecommendVideos(): Promise<void> {
    if (this.isLoading || !this.hasMore) {
      return;
    }

    this.isLoading = true;
    try {
      const response: BilibiliRecommendResponse = await apiService.getBilibiliRecommendVideos(this.userToken, this.currentPage);
      
      if (response && response.videos) {
        const newVideos: VideoInfo[] = response.videos.map((item) => {
          const video: VideoInfo = {
            bvid: item.bvid,
            name: item.owner?.name || 'æœªçŸ¥UPä¸»',
            description: item.title || 'æ— æ ‡é¢˜',
            pic: item.pic || '',
            view: item.stat?.view || 0,
            danmaku: item.stat?.danmaku || 0,
            duration: item.duration || 0,
            tname: item.tname || 'æœªçŸ¥åˆ†ç±»'
          };
          return video;
        });
        
        if (this.currentPage === 1) {
          this.videoList = newVideos;
        } else {
          this.videoList = this.videoList.concat(newVideos);
        }
        
        this.hasMore = response.has_more;
        this.currentPage++;
      }
    } catch (error) {
      console.error('åŠ è½½æ¨èè§†é¢‘å¤±è´¥:', error);
      // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œå›é€€åˆ°åŸæ¥çš„æ–¹å¼
      await this.loadData();
    } finally {
      this.isLoading = false;
    }
  }

  // åŠ è½½æ•°æ®çš„å…¬å…±æ–¹æ³•
  private async loadData(): Promise<void> {
    try {
      let sessdata: string = '';
      let useBackupSessdata = false;
      // å¦‚æœæ­£åœ¨åŠ è½½tokenï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´
      if (!this.userToken) {
        const verifiedToken = AppStorage.get('verifiedToken') as string;
        if (verifiedToken) {
          this.userToken = verifiedToken;
        }
      }
      // å¦‚æœæœ‰ç”¨æˆ·tokenï¼Œå°è¯•ä»APIè·å–æœ€æ–°çš„SESSDATA
      if (this.userToken) {
        console.log('ğŸ”„ æ£€æµ‹åˆ°ç”¨æˆ·tokenï¼Œå°è¯•è·å–åŠ¨æ€SESSDATA...');
        try {
          const authInfo = await apiService.getBilibiliAuthInfo(this.userToken);
          console.log('ğŸ“‹ è·å–é‰´æƒä¿¡æ¯æˆåŠŸ:', {
            nickname: authInfo.nickname,
            dedeuserid: authInfo.dedeuserid,
            hasSessdata: !!authInfo.cookies?.SESSDATA
          });
          
          if (authInfo.cookies && authInfo.cookies.SESSDATA) {
            sessdata = authInfo.cookies.SESSDATA;
            console.log('âœ… æˆåŠŸè·å–åŠ¨æ€SESSDATA');
          } else {
            console.warn('âš ï¸ APIè¿”å›çš„é‰´æƒä¿¡æ¯ä¸­æ²¡æœ‰SESSDATAï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
            useBackupSessdata = true;
          }
        } catch (error) {
          console.error('âŒ è·å–åŠ¨æ€SESSDATAå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', error);
          useBackupSessdata = true;
        }
      } else {
        console.log('âš ï¸ æ²¡æœ‰tokenï¼Œä½¿ç”¨å¤‡ç”¨SESSDATA');
        useBackupSessdata = true;
      }
      
      // ä½¿ç”¨å¤‡ç”¨SESSDATA
      if (useBackupSessdata) {
        sessdata = '59a10793,1762276359,7f149*51CjBbahzoY1V9kQMXI0YfxO_OQE5JrLc-MQowZ4rizmyd6DSacH1NSjwQPSxNII6BYEISVlpWZ1N3TlRmU05BVUxlRXB4ZG5vSVpiNjZrNVFzNk43cDNjQWQ5Y0pqU3ltVXhmaHA1cEVMTlhNZXVsTVNNM21mWUVXLW5JckV1eEtPd0c3Rm1vMVJBIIEC';
        console.log('ğŸ”§ å·²è®¾ç½®å¤‡ç”¨SESSDATA');
      }
      
      console.log('ğŸ¯ å½“å‰ä½¿ç”¨çš„SESSDATA:', sessdata.substring(0, 20) + '...');
      const response = await requestSelf(sessdata, http.RequestMethod.GET, null);

      if (response) {
        this.apiResponse = response; // å­˜å‚¨åŸå§‹å“åº”ç»“æœ
        this.parseApiResponse(response as Record<string, Object>); // è§£æå“åº”å¹¶å­˜å‚¨è§†é¢‘æ•°æ®
      } else {
        console.error('è¯·æ±‚å¤±è´¥');
      }
    } catch (error) {
      console.error('loadDataæ–¹æ³•æ‰§è¡Œå¤±è´¥:', error);
    }
  }

  private parseApiResponse(response: Record<string, Object>): void {
    console.info(JSON.stringify(response));
    const responseData = response as Record<string, Object>;
    const code = responseData.code as number;
    const data = responseData.data as Record<string, Object>;
    
    if (code === 0 && data && data.item) {
      const items: Object[] = data.item as Object[];

      for (let i = 0; i < items.length; i++) {
        const item = items[i] as Record<string, Object>;
        const owner = item.owner as Record<string, Object>;
        const stat = item.stat as Record<string, Object>;

        this.datas.pushData({
          description: item.title as string, // æ ‡é¢˜
          head: item.pic as string, // å°é¢URL
          video: item.uri as string, // è§†é¢‘é“¾æ¥
          audioUrl: '', // éŸ³é¢‘é“¾æ¥
          bvid: item.bvid as string,//åœ°å€
          aid: String(item.aid || 0), // AVå·
          cid: String(item.cid || 0), // CID
          name: owner.name as string, // UPä¸»
          face: owner.face as string,
          view: stat.view as number, // æ’­æ”¾é‡
          total:'55555',
          like: stat.like as number,//ç‚¹èµ
          barrage: stat.danmaku as number, // å¼¹å¹•æ•°
          time: item.duration as number, // æ—¶é•¿
          pubdate: item.pubdate as number,//å‘å¸ƒæ—¶é—´
          coins: '55555',//æŠ•å¸
          favorites: '55555',//æ”¶è—
          shares: '55555',//è½¬å‘
          reply: String(stat.reply || 0), // è¯„è®ºæ•°
          tname: (item.tname as string) || '', // åˆ†åŒºåç§°
          controller: this.myController,
          auto:true,
          play:true,
          index: String(i),
        });
      }
    } else {
      console.error('API å“åº”é”™è¯¯æˆ–æ•°æ®ç¼ºå¤±');
    }
  }

  // åˆ—è¡¨åˆ°åº•éƒ¨æ—¶è§¦å‘
  private async onReachEnd() {
    if (this.isLoading || !this.hasMore) {
      return; // å¦‚æœæ­£åœ¨åŠ è½½æˆ–æ²¡æœ‰æ›´å¤šæ•°æ®ï¼Œåˆ™ä¸æ‰§è¡Œ
    }
    
    if (this.userToken) {
      await this.loadRecommendVideos(); // ä½¿ç”¨æ–°APIåŠ è½½æ›´å¤šæ•°æ®
    } else {
      this.loadingMore = true;
      await this.loadData(); // ä½¿ç”¨åŸæ¥çš„æ–¹å¼åŠ è½½æ›´å¤šæ•°æ®
      this.loadingMore = false;
    }
  }

  // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤ºï¼ˆå¦‚æ’­æ”¾é‡ã€å¼¹å¹•æ•°ï¼‰
  private formatNumber(num: number): string {
    if (num >= 100000000) {
      return (num / 100000000).toFixed(1) + 'äº¿';
    } else if (num >= 10000) {
      return (num / 10000).toFixed(1) + 'ä¸‡';
    } else {
      return num.toString();
    }
  }

  // æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º
  private formatDuration(seconds: number): string {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
      return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
      return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
  }

  onPageShow(): void {
    const currentData = this.datas.getData(this.index);
    if (currentData && currentData.controller) {
      if (currentData.controller && typeof currentData.controller.start === 'function') {
        currentData.controller.start();
      }
    }
  }

  onPageHide(): void {
    const currentData = this.datas.getData(this.index);
    if (currentData && currentData.controller) {
      if (currentData.controller && typeof currentData.controller.pause === 'function') {
        currentData.controller.pause();
      }
    }
  }

  // æ¨¡å¼åˆ‡æ¢æ–¹æ³•
  private toggleMode() {
    this.isHistoryMode = !this.isHistoryMode;
    console.log(`ğŸ”„ åˆ‡æ¢åˆ°${this.isHistoryMode ? 'å†å²' : 'å®æ—¶'}æ¨¡å¼`);
    // æ¨¡å¼åˆ‡æ¢åªå½±å“ç‚¹å‡»è§†é¢‘åçš„æ’­æ”¾åˆ—è¡¨ï¼Œä¸å½±å“é¦–é¡µæ˜¾ç¤ºå†…å®¹
  }

  // åŠ è½½å†å²è§†é¢‘æ•°æ®
  private async loadHistoryVideos(): Promise<void> {
    if (!this.userToken) {
      console.warn('âš ï¸ æ²¡æœ‰ç”¨æˆ·tokenï¼Œæ— æ³•åŠ è½½å†å²è§†é¢‘');
      return;
    }

    this.isLoading = true;
    try {
      console.log('ğŸ”„ å¼€å§‹åŠ è½½å†å²è§†é¢‘æ•°æ®...');
      const videos = await apiService.getUserVideos(this.userToken);
      
      if (videos && videos.length > 0) {
        // è½¬æ¢ä¸ºVideoDataæ ¼å¼
        const historyVideoData = videos.map((item, index) => {
          const videoData: VideoData = {
            description: item.title,
            head: item.pic,
            video: item.download_link,
            audioUrl: '',
            bvid: item.bvid,
            aid: item.aid || '',
            cid: item.cid || '',
            name: item.name,
            face: item.face,
            view: item.view || '0',
            total: item.current_viewers || '0',
            like: item.like || '0',
            barrage: item.danmaku || '0',
            time: item.duration || '0',
            pubdate: item.pubdate || '0',
            coins: item.coin || '0',
            favorites: item.favorite || '0',
            shares: item.share || '0',
            reply: item.reply || '0',
            tname: item.tname || '',
            controller: this.myController,
            auto: true,
            play: true,
            index: String(index),
            preloaded_url: item.download_link // å†å²è§†é¢‘å·²æœ‰ä¸‹è½½é“¾æ¥
          };
          return videoData;
        });
        
        // å­˜å‚¨å†å²è§†é¢‘æ•°æ®
        this.historyVideos = historyVideoData;
        
        // æ¸…ç©ºå¹¶é‡æ–°å¡«å……æ•°æ®æº
        this.datas.clearData();
        historyVideoData.forEach(video => {
          this.datas.pushData(video);
        });
        
        console.log(`âœ… æˆåŠŸåŠ è½½${historyVideoData.length}ä¸ªå†å²è§†é¢‘`);
      } else {
        console.log('ğŸ“­ æ²¡æœ‰æ‰¾åˆ°å†å²è§†é¢‘æ•°æ®');
      }
    } catch (error) {
      console.error('âŒ åŠ è½½å†å²è§†é¢‘å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // é‡æ–°æ’åºè§†é¢‘åˆ—è¡¨ï¼Œå°†æŒ‡å®šç´¢å¼•çš„è§†é¢‘æ”¾åœ¨ç¬¬ä¸€ä½
  private reorderVideosForPlayback(videos: VideoData[], targetIndex: number): VideoData[] {
    if (targetIndex < 0 || targetIndex >= videos.length) {
      return videos;
    }
    
    const reordered = [...videos];
    const targetVideo = reordered.splice(targetIndex, 1)[0];
    reordered.unshift(targetVideo);
    
    console.info(`è§†é¢‘åˆ—è¡¨å·²é‡æ’åºï¼Œç›®æ ‡è§†é¢‘"${targetVideo.name}"ç°åœ¨ä½äºç¬¬ä¸€ä½`);
    return reordered;
  }

  // é¢„åŠ è½½å†å²è§†é¢‘çš„æ’­æ”¾é“¾æ¥
  private async preloadHistoryVideos(videos: VideoData[]): Promise<void> {
    if (!this.userToken) {
      console.error('âŒ æ²¡æœ‰ç”¨æˆ·tokenï¼Œæ— æ³•é¢„åŠ è½½å†å²è§†é¢‘');
      return;
    }

    console.log(`ğŸ§  å¼€å§‹é¢„åŠ è½½${videos.length}ä¸ªå†å²è§†é¢‘çš„æ’­æ”¾é“¾æ¥`);
    
    // åˆ†æ‰¹é¢„åŠ è½½ï¼Œé¿å…åŒæ—¶å‘èµ·å¤ªå¤šè¯·æ±‚
    const batchSize = 3;
    for (let i = 0; i < videos.length; i += batchSize) {
      const batch = videos.slice(i, i + batchSize);
      const batchPromises = batch.map(async (video, batchIndex) => {
        const globalIndex = i + batchIndex;
        return this.preloadSingleHistoryVideo(video, globalIndex);
      });
      
      // ç­‰å¾…å½“å‰æ‰¹æ¬¡å®Œæˆå†è¿›è¡Œä¸‹ä¸€æ‰¹
      await Promise.allSettled(batchPromises);
      console.log(`ğŸ“¦ æ‰¹æ¬¡ ${Math.floor(i/batchSize) + 1} é¢„åŠ è½½å®Œæˆ`);
    }
    
    console.log(`ğŸ‰ å†å²è§†é¢‘é¢„åŠ è½½å®Œæˆï¼Œå…±å¤„ç†${videos.length}ä¸ªè§†é¢‘`);
  }

  // é¢„åŠ è½½å•ä¸ªå†å²è§†é¢‘çš„æ’­æ”¾é“¾æ¥ - ä¸Dynamic.etsçš„preloadSingleVideoå®Œå…¨ä¸€è‡´
  private async preloadSingleHistoryVideo(video: VideoData, index: number): Promise<void> {
    try {
      // æ£€æŸ¥æ˜¯å¦å·²ç»é¢„åŠ è½½è¿‡
      if (video.video && typeof video.video === 'string' && video.video.startsWith('http')) {
        console.log(`âš¡ è§†é¢‘ ${video.bvid} å·²æœ‰æ’­æ”¾é“¾æ¥ï¼Œè·³è¿‡é¢„åŠ è½½`);
        return;
      }
      
      // ä½¿ç”¨å½“å‰çš„tokenè¿›è¡Œé‰´æƒ
      if (!this.userToken) {
        console.error(`âŒ Tokenä¸å­˜åœ¨ï¼Œæ— æ³•é¢„åŠ è½½è§†é¢‘ ${video.bvid}`);
        return;
      }
      
      console.log(`ğŸ”„ å¼€å§‹é¢„åŠ è½½è§†é¢‘ ${index}: ${video.description} (${video.bvid})`);
      
      // ä½¿ç”¨generate-download-link APIè·å–çœŸæ­£å¯æ’­æ”¾çš„é“¾æ¥
      const fileName = `${video.bvid}.mp4`;
      const response = await apiService.generateDownloadLink(this.userToken, fileName);
      
      if (response && response.downloadUrl) {
        // å°†è·å–åˆ°çš„æ’­æ”¾é“¾æ¥å­˜å‚¨åˆ°è§†é¢‘æ•°æ®ä¸­
        video.video = response.downloadUrl;
        
        console.log(`âœ… è§†é¢‘ ${video.bvid} é¢„åŠ è½½æˆåŠŸï¼Œæ’­æ”¾é“¾æ¥: ${response.downloadUrl}`);
        console.log(`ğŸ”‘ ä¸‹è½½token: ${response.token}`);
        console.log(`â° é“¾æ¥è¿‡æœŸæ—¶é—´: ${response.expiresAt}`);
      } else {
        console.warn(`âš ï¸ è§†é¢‘ ${video.bvid} é¢„åŠ è½½å¤±è´¥ï¼šAPIè¿”å›æ•°æ®å¼‚å¸¸`);
        console.warn(`ğŸ“‹ APIå“åº”:`, response);
      }
    } catch (error) {
      console.error(`âŒ è§†é¢‘ ${video.bvid} é¢„åŠ è½½å¤±è´¥:`, error);
      // é¢„åŠ è½½å¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹ï¼Œç»§ç»­å¤„ç†å…¶ä»–è§†é¢‘
      
      // å¦‚æœæ˜¯æƒé™é—®é¢˜ï¼Œå°è¯•ä½¿ç”¨åŸæœ‰çš„ä¸‹è½½é“¾æ¥
      if (video.video && typeof video.video === 'string' && !video.video.startsWith('http')) {
        console.log(`ğŸ”„ å°è¯•ä½¿ç”¨åŸæœ‰ä¸‹è½½é“¾æ¥: ${video.video}`);
        // ä¿æŒåŸæœ‰é“¾æ¥ä¸å˜
      }
    }
  }

  build() {
    Scroll() {
      Column() {
        // é¡¶éƒ¨æ ‡é¢˜æ ï¼ŒåŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œæ¨¡å¼åˆ‡æ¢
        Row() {
          Text("å“”å“©å“”å“©")
            .fontSize(20)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)
            .textAlign(TextAlign.Start)
            .margin({ left: 16 })
          
          // æ¨¡å¼åˆ‡æ¢æŒ‰é’®
          Button(this.isHistoryMode ? "å†å²" : "å®æ—¶")
            .fontSize(12)
            .fontColor(this.isHistoryMode ? '#ff6699' : Color.White)
            .backgroundColor(this.isHistoryMode ? Color.White : 'rgba(255, 255, 255, 0.3)')
            .borderRadius(12)
            .padding({ left: 12, right: 12, top: 4, bottom: 4 })
            .margin({ right: 8 })
            .onClick(() => {
              this.toggleMode();
            })
          
          // ç”¨æˆ·é‰´æƒä¿¡æ¯æ˜¾ç¤º - ç§»åˆ°å³ä¸Šè§’
          if (this.bilibiliAuthInfo) {
            Row() {
              Text(this.bilibiliAuthInfo.nickname)
                .fontSize(14)
                .fontColor(Color.White)
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .margin({ right: 8 })
              
              if (this.bilibiliAuthInfo.avatar) {
                Image(this.bilibiliAuthInfo.avatar)
                  .width(32)
                  .height(32)
                  .borderRadius(16)
                  .border({ width: 2, color: Color.White })
              }
            }
            .padding({ right: 16 })
            .alignItems(VerticalAlign.Center)
          } else if (this.userToken) {
            Row() {
              Text("ç™»å½•ä¸­...")
                .fontSize(14)
                .fontColor('#FFFFFF')
                .margin({ right: 8 })
              
              Circle({ width: 32, height: 32 })
                .fill('#FFFFFF33')
                .margin({ right: 16 })
            }
          } else {
            Row() {
              Text("æœªç™»å½•")
                .fontSize(14)
                .fontColor('#FFFFFF')
                .margin({ right: 8 })
              
              Circle({ width: 32, height: 32 })
                .fill('#FFFFFF33')
                .margin({ right: 16 })
            }
          }
        }
        .width("100%")
        .height("10%")
        // .backgroundColor('#FB7299')
        .backgroundColor('#ff6699')
        .padding({ top: 8, bottom: 8 })
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)
        Tabs({ barPosition: BarPosition.Start ,index: this.bottomTabIndex})
        {
          TabContent() {
          }.tabBar("ç›´æ’­");

          TabContent() {
            List({ space: 5 }) {
              
              LazyForEach(this.datas, (item: VideoData, index: number) => {
                ListItem() {
                  Column() {
                    // å›¾ç‰‡å®¹å™¨
                    Stack() {
                      Image(item.head)
                        .width('100%')
                        .height(130)
                        .objectFit(ImageFit.Cover)
                        .borderRadius({ topLeft: 8, topRight: 8 })

                      // åº•éƒ¨ä¿¡æ¯æ ï¼šæ’­æ”¾é‡å¼¹å¹•åœ¨å·¦ï¼Œæ—¶é•¿åœ¨å³
                      Row() {
                        // æ’­æ”¾é‡å’Œå¼¹å¹•æ•°åœ¨å·¦ä¾§
                        Row() {
                          if (Number(item.view) > 0) {
                            Text(`${this.formatNumber(Number(item.view))}æ’­æ”¾`)
                              .fontSize(11)
                              .fontColor(Color.White)
                              .margin({ right: 8 })
                          }
                          if (Number(item.barrage) > 0) {
                            Text(`${this.formatNumber(Number(item.barrage))}å¼¹å¹•`)
                              .fontSize(11)
                              .fontColor(Color.White)
                          }
                        }
                        .backgroundColor('rgba(0, 0, 0, 0.7)')
                        .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                        .borderRadius(4)
                        
                        Blank()
                        
                        // æ—¶é•¿åœ¨å³ä¾§
                        if (Number(item.time) > 0) {
                          Text(this.formatDuration(Number(item.time)))
                            .fontSize(11)
                            .fontColor(Color.White)
                            .backgroundColor('rgba(0, 0, 0, 0.7)')
                            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                            .borderRadius(4)
                        }
                      }
                      .width('100%')
                      .padding({ left: 2, right: 2, bottom: 2 })
                      .position({ x: 0, y: '100%' })
                      .translate({ x: 0, y: -2 })
                      .markAnchor({ x: 0, y: '100%' })
                    }
                    .width('100%')
                    .height(130)
                    
                    // è§†é¢‘ä¿¡æ¯åŒºåŸŸ
                    Column() {
                      // è§†é¢‘æ ‡é¢˜
                      Text(item.description)
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#333333')
                        .maxLines(2)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                        .lineHeight(20)
                        .width('100%')
                        .height(48)  // å›ºå®šé«˜åº¦ï¼š20pxè¡Œé«˜ Ã— 2è¡Œ + 8pxé—´è·
                        .margin({ bottom: 8 })
                      
                      // ä½œè€…ä¿¡æ¯å’Œåˆ†ç±»æ ‡ç­¾
                      Row() {
                        Text(item.name)
                          .fontSize(12)
                          .fontColor('#666666')
                          .fontWeight(FontWeight.Normal)
                          .maxLines(1)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                          .layoutWeight(1)
                        
                        if (item.tname && item.tname !== '') {
                          Text(item.tname)
                            .fontSize(10)
                            .fontColor('#FB7299')
                            .backgroundColor('#FFF0F5')
                            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                            .borderRadius(10)
                        }
                      }
                      .width('100%')
                    }
                    .padding({ left: 12, right: 12, top: 10, bottom: 12 })
                    .alignItems(HorizontalAlign.Start)
                    .backgroundColor(Color.White)
                    .borderRadius({ bottomLeft: 8, bottomRight: 8 })
                  }
                  .onClick(async () => {
                      console.log(`è§†é¢‘åç§°: ${item.description}`);
                      console.log(`BVID: ${item.bvid}`);
                      console.log(`å½“å‰æ¨¡å¼: ${this.isHistoryMode ? 'å†å²' : 'å®æ—¶'}`);
                      
                      try {
                        if (this.isHistoryMode) {
                          // å†å²æ¨¡å¼ï¼šåƒDynamic.etsä¸€æ ·å¤„ç†å†å²è®°å½•è§‚çœ‹
                          console.log('ğŸ¯ å†å²æ¨¡å¼ï¼šç‚¹å‡»è§†é¢‘è¿›è¡Œå†å²è®°å½•è§‚çœ‹');
                          
                          // ç¡®ä¿æœ‰æœ‰æ•ˆçš„token
                          if (!this.userToken) {
                            console.error('âŒ æ²¡æœ‰ç”¨æˆ·tokenï¼Œæ— æ³•è·å–å†å²è§†é¢‘');
                            promptAction.showToast({ message: 'è¯·å…ˆç™»å½•è´¦å·' });
                            return;
                          }
                          
                          // è·å–å®Œæ•´çš„å†å²è§†é¢‘åˆ—è¡¨ç”¨äºæ’­æ”¾
                          const allHistoryVideos = await apiService.getUserVideos(this.userToken);
                          
                          if (!allHistoryVideos || allHistoryVideos.length === 0) {
                            console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å†å²è§†é¢‘');
                            promptAction.showToast({ message: 'æ²¡æœ‰æ‰¾åˆ°å†å²è§†é¢‘' });
                            return;
                          }
                          
                          // è½¬æ¢ä¸ºVideoDataæ ¼å¼
                          const allHistoryVideoData = allHistoryVideos.map((historyItem, index) => {
                            const videoData: VideoData = {
                              description: historyItem.title,
                              head: historyItem.pic,
                              video: historyItem.download_link,
                              audioUrl: '',
                              bvid: historyItem.bvid,
                              aid: historyItem.aid || '',
                              cid: historyItem.cid || '',
                              name: historyItem.name,
                              face: historyItem.face,
                              view: historyItem.view || '0',
                              total: historyItem.current_viewers || '0',
                              like: historyItem.like || '0',
                              barrage: historyItem.danmaku || '0',
                              time: historyItem.duration || '0',
                              pubdate: historyItem.pubdate || '0',
                              coins: historyItem.coin || '0',
                              favorites: historyItem.favorite || '0',
                              shares: historyItem.share || '0',
                              reply: historyItem.reply || '0',
                              tname: historyItem.tname || '',
                              controller: this.myController,
                              auto: true,
                              play: true,
                              index: String(index)
                            };
                            return videoData;
                          });
                          
                          // æ‰¾åˆ°ç‚¹å‡»çš„è§†é¢‘åœ¨å†å²åˆ—è¡¨ä¸­çš„ç´¢å¼•
                          const clickedHistoryIndex = allHistoryVideoData.findIndex(video => video.bvid === item.bvid);
                          
                          let finalVideos: VideoData[] = [];
                          let startIndex = 0;
                          
                          if (clickedHistoryIndex >= 0) {
                            // ç‚¹å‡»çš„æ˜¯å†å²è§†é¢‘ï¼Œé‡æ–°æ’åºå†å²åˆ—è¡¨
                            console.log(`ğŸ¯ ç‚¹å‡»çš„æ˜¯å†å²è§†é¢‘ï¼Œç´¢å¼•: ${clickedHistoryIndex}`);
                            finalVideos = this.reorderVideosForPlayback(allHistoryVideoData, clickedHistoryIndex);
                            startIndex = 0; // é‡æ’åä»ç¬¬ä¸€ä¸ªå¼€å§‹æ’­æ”¾
                            
                            // ä¼˜å…ˆä¸ºç‚¹å‡»çš„å†å²è§†é¢‘è·å–æ’­æ”¾é“¾æ¥ï¼Œç¡®ä¿ç¬¬ä¸€ä¸ªè§†é¢‘å¯æ’­æ”¾
                            console.log(`ğŸ¯ ä¼˜å…ˆä¸ºç‚¹å‡»çš„å†å²è§†é¢‘è·å–æ’­æ”¾é“¾æ¥: ${finalVideos[0].bvid}`);
                            await this.preloadSingleHistoryVideo(finalVideos[0], 0);
                            
                            // éªŒè¯ç¬¬ä¸€ä¸ªè§†é¢‘æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ’­æ”¾é“¾æ¥
                            if (!finalVideos[0].video || !finalVideos[0].video.toString().startsWith('http')) {
                              console.error(`âŒ å†å²è§†é¢‘ ${finalVideos[0].bvid} æ²¡æœ‰è·å–åˆ°æœ‰æ•ˆæ’­æ”¾é“¾æ¥ï¼Œæ— æ³•æ’­æ”¾`);
                              promptAction.showToast({ message: 'è§†é¢‘é“¾æ¥è·å–å¤±è´¥ï¼Œè¯·é‡è¯•' });
                              return;
                            }
                            
                            // é¢„åŠ è½½å…¶ä»–å†å²è§†é¢‘çš„æ’­æ”¾é“¾æ¥ï¼ˆå¼‚æ­¥è¿›è¡Œï¼Œä¸é˜»å¡è·³è½¬ï¼‰
                            console.log('ğŸš€ å¼€å§‹é¢„åŠ è½½å…¶ä»–å†å²è§†é¢‘çš„æ’­æ”¾é“¾æ¥...');
                            this.preloadHistoryVideos(finalVideos.slice(1, 5)); // å¼‚æ­¥é¢„åŠ è½½ç¬¬2-5ä¸ªè§†é¢‘
                          } else {
                            // ç‚¹å‡»çš„æ˜¯æ¨èè§†é¢‘ï¼Œéœ€è¦è§£æå¹¶æ’å…¥åˆ°å†å²åˆ—è¡¨
                            console.log('ğŸ†• ç‚¹å‡»çš„æ˜¯æ¨èè§†é¢‘ï¼Œå°†å…¶æ’å…¥åˆ°å†å²åˆ—è¡¨å¼€å¤´');
                            
                            // å…ˆè§£æè§†é¢‘è·å–è¯¦ç»†ä¿¡æ¯
                            try {
                              console.log(`ğŸ”„ å¼€å§‹è§£æè§†é¢‘: ${item.bvid}`);
                              
                              if (!this.userToken) {
                                console.error('âŒ Tokenä¸å­˜åœ¨ï¼Œæ— æ³•è§£æè§†é¢‘');
                                promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' });
                                return;
                              }
                              
                              // æ„é€ è§†é¢‘URLç”¨äºè§£æ
                              const videoUrl = `https://www.bilibili.com/video/${item.bvid}`;
                              
                              // è°ƒç”¨parseVideo APIè·å–è§†é¢‘è¯¦æƒ…
                              console.log(`ğŸš€ è°ƒç”¨parseVideo APIè§£æè§†é¢‘: ${item.bvid}`);
                              const parseResult = await apiService.parseVideoDetails(this.userToken, videoUrl);
                              
                              if (parseResult) {
                                console.log(`âœ… è§†é¢‘è§£ææˆåŠŸ: ${item.bvid}`);
                                console.log(`ğŸ”— è§†é¢‘é“¾æ¥: ${parseResult.videoUrl}`);
                                console.log(`ğŸ”— éŸ³é¢‘é“¾æ¥: ${parseResult.audioUrl}`);
                                console.log(`ğŸ“‹ è§†é¢‘æ ‡é¢˜: ${parseResult.title}`);
                                
                                // åˆ›å»ºç‚¹å‡»è§†é¢‘çš„VideoDataï¼Œä½¿ç”¨è§£æç»“æœå¡«å……
                                const clickedVideoData: VideoData = {
                                  description: parseResult.title || item.description,
                                  head: item.head || '',
                                  video: parseResult.videoUrl, // ä½¿ç”¨è§£æå¾—åˆ°çš„è§†é¢‘é“¾æ¥
                                  audioUrl: parseResult.audioUrl,
                                  bvid: parseResult.bvid || item.bvid,
                                  aid: parseResult.aid || item.aid || '',
                                  cid: parseResult.cid || item.cid || '',
                                  name: parseResult.name || item.name,
                                  face: parseResult.face || item.face,
                                  view: String(parseResult.view || item.view),
                                  total: item.total || '0',
                                  like: String(parseResult.like || item.like || '0'),
                                  barrage: String(parseResult.danmaku || item.barrage || 0),
                                  time: String(parseResult.duration || item.time || 0),
                                  pubdate: String(parseResult.pubdate || item.pubdate || '0'),
                                  coins: String(parseResult.coin || item.coins || '0'),
                                  favorites: String(parseResult.favorite || item.favorites || '0'),
                                  shares: String(parseResult.share || item.shares || '0'),
                                  reply: String(parseResult.reply || item.reply || '0'),
                                  tname: parseResult.tname || item.tname || 'æ¨è',
                                  controller: this.myController,
                                  auto: true,
                                  play: true,
                                  index: '0'
                                };
                                
                                // å°†ç‚¹å‡»çš„è§†é¢‘æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œåé¢è·Ÿå†å²è§†é¢‘
                                finalVideos = [clickedVideoData, ...allHistoryVideoData];
                                startIndex = 0;

                                // å†å²æ¨¡å¼ï¼šå¼‚æ­¥è§£ææ¨èè§†é¢‘ï¼Œä¸ç­‰å¾…è§£æå®Œæˆå°±è·³è½¬
                                console.log(`ğŸ¯ å†å²æ¨¡å¼ï¼šå¼€å§‹å¼‚æ­¥è§£ææ¨èè§†é¢‘: ${item.bvid}`);

                                // æ„é€ è§†é¢‘URLç”¨äºè§£æ
                                const videoUrl = `https://www.bilibili.com/video/${item.bvid}`;

                                // å¼‚æ­¥è°ƒç”¨è§†é¢‘è§£ææ¥å£ï¼Œä¸ç­‰å¾…å®Œæˆ
                                this.processRecommendedVideoAsync(videoUrl, item.bvid, finalVideos).catch((error: Error) => {
                                  console.error(`âŒ å¼‚æ­¥è§£æè§†é¢‘å¤±è´¥: ${item.bvid}`, error);
                                });

                                console.log(`ğŸš€ æ¨èè§†é¢‘ ${item.bvid} è§£æä»»åŠ¡å·²æäº¤ï¼Œç”¨æˆ·å¯ä»¥è§‚çœ‹å†å²è§†é¢‘ç­‰å¾…è§£æå®Œæˆ`);

                                // é¢„åŠ è½½å…¶ä»–å†å²è§†é¢‘çš„æ’­æ”¾é“¾æ¥ï¼ˆå¼‚æ­¥è¿›è¡Œï¼Œä¸é˜»å¡è·³è½¬ï¼‰
                                console.log('ğŸš€ å¼€å§‹é¢„åŠ è½½å…¶ä»–å†å²è§†é¢‘çš„æ’­æ”¾é“¾æ¥...');
                                this.preloadHistoryVideos(finalVideos.slice(1, 6)); // å¼‚æ­¥é¢„åŠ è½½ç¬¬2-6ä¸ªè§†é¢‘

                                // // è·³è½¬åˆ°è§†é¢‘æ’­æ”¾é¡µé¢ï¼Œä¼ é€’ä¸Dynamic.etså®Œå…¨ç›¸åŒçš„å‚æ•°
                                // console.log(`ğŸš€ è·³è½¬åˆ°è§†é¢‘æ’­æ”¾é¡µé¢ï¼Œç¬¬ä¸€ä¸ªè§†é¢‘: ${finalVideos[0].bvid}`);
                                // router.pushUrl({
                                //   url: "pages/VideoPlayer",
                                //   params: {
                                //     videoDatas: finalVideos,
                                //     bvidflag: item.bvid,
                                //     startIndex: 0, // ä»é‡æ’åçš„ç¬¬ä¸€ä¸ªå¼€å§‹æ’­æ”¾
                                //     userToken: this.userToken, // ä¼ é€’ç”¨æˆ·token
                                //     preloadedCount: 1, // å·²é¢„åŠ è½½çš„è§†é¢‘æ•°é‡ï¼ˆç¬¬ä¸€ä¸ªè§†é¢‘ï¼‰
                                //     enableSmartPreload: true, // å¯ç”¨æ™ºèƒ½é¢„åŠ è½½
                                //     preloadRange: 5 // é¢„åŠ è½½èŒƒå›´ï¼ˆå½“å‰è§†é¢‘å‰å5ä¸ªï¼‰
                                //   }
                                // });
                              } else {
                                console.error(`âŒ è§†é¢‘è§£æå¤±è´¥: ${item.bvid}`);
                                promptAction.showToast({ message: 'è§†é¢‘è§£æå¤±è´¥ï¼Œè¯·é‡è¯•' });
                              }
                            } catch (error) {
                              console.error(`âŒ è§£æè§†é¢‘æ—¶å‘ç”Ÿé”™è¯¯: ${item.bvid}`, error);
                              promptAction.showToast({ message: `è§£æè§†é¢‘å¤±è´¥: ${error.message}` });
                            }
                          }
                          
                          // æœ€ç»ˆéªŒè¯ç¬¬ä¸€ä¸ªè§†é¢‘çš„æ’­æ”¾é“¾æ¥ï¼ˆå†å²æ¨¡å¼ä¸‹æ¨èè§†é¢‘å¯èƒ½æ­£åœ¨å¼‚æ­¥è§£æï¼‰
                          console.log(`ğŸ” æœ€ç»ˆéªŒè¯ç¬¬ä¸€ä¸ªè§†é¢‘æ’­æ”¾é“¾æ¥: ${finalVideos[0].video}`);
                          if (!finalVideos[0].video || !finalVideos[0].video.toString().startsWith('http')) {
                            // åœ¨å†å²æ¨¡å¼ä¸‹ï¼Œå¦‚æœç¬¬ä¸€ä¸ªè§†é¢‘æ˜¯æ¨èè§†é¢‘ä¸”æ­£åœ¨è§£æï¼Œè¿™æ˜¯æ­£å¸¸çš„
                            if (clickedHistoryIndex < 0) {
                              console.log(`â³ æ¨èè§†é¢‘ ${finalVideos[0].bvid} æ­£åœ¨å¼‚æ­¥è§£æä¸­ï¼Œç”¨æˆ·å¯ä»¥å…ˆè§‚çœ‹å†å²è§†é¢‘`);
                            } else {
                              console.error(`âŒ å†å²è§†é¢‘æ²¡æœ‰æœ‰æ•ˆçš„æ’­æ”¾é“¾æ¥ï¼Œæ— æ³•æ’­æ”¾`);
                              promptAction.showToast({ message: 'è§†é¢‘é“¾æ¥æ— æ•ˆï¼Œè¯·é‡è¯•' });
                              return;
                            }
                          }
                          
                          // è·³è½¬åˆ°è§†é¢‘æ’­æ”¾é¡µé¢ï¼Œä¼ é€’ä¸Dynamic.etså®Œå…¨ç›¸åŒçš„å‚æ•°
                          console.log(`ğŸš€ è·³è½¬åˆ°è§†é¢‘æ’­æ”¾é¡µé¢ï¼Œç¬¬ä¸€ä¸ªè§†é¢‘: ${finalVideos[0].bvid}`);
                          router.pushUrl({
                            url: "pages/VideoPlayer",
                            params: {
                              videoDatas: finalVideos,
                              bvidflag: item.bvid,
                              startIndex: 0, // ä»é‡æ’åçš„ç¬¬ä¸€ä¸ªå¼€å§‹æ’­æ”¾
                              userToken: this.userToken, // ä¼ é€’ç”¨æˆ·token
                              preloadedCount: 1, // å·²é¢„åŠ è½½çš„è§†é¢‘æ•°é‡ï¼ˆç¬¬ä¸€ä¸ªè§†é¢‘ï¼‰
                              enableSmartPreload: true, // å¯ç”¨æ™ºèƒ½é¢„åŠ è½½
                              preloadRange: 5 // é¢„åŠ è½½èŒƒå›´ï¼ˆå½“å‰è§†é¢‘å‰å5ä¸ªï¼‰
                            }
                          });
                          
                        } else {
                          // å®æ—¶æ¨¡å¼ï¼šä½¿ç”¨æ¨èè§†é¢‘åˆ—è¡¨
                          console.log('ğŸ”„ å®æ—¶æ¨¡å¼ï¼šä½¿ç”¨æ¨èè§†é¢‘åˆ—è¡¨');
                          
                          const allVideos = this.datas.getAllData();
                          const clickedIndex = allVideos.findIndex(video => video.bvid === item.bvid);
                          const startIndex = clickedIndex >= 0 ? clickedIndex : 0;
                          const reorderedVideos = this.reorderVideosForPlayback(allVideos, startIndex);
                          
                          // è·³è½¬åˆ°è§†é¢‘æ’­æ”¾é¡µé¢
                          router.pushUrl({
                            url: "pages/VideoPlayer",
                            params: {
                              videoDatas: reorderedVideos,
                              bvidflag: item.bvid,
                              startIndex: 0,
                              fromHome: true,
                              userToken: this.userToken,
                              playbackMode: 'realtime'
                            }
                          });
                        }
                        
                      } catch (error) {
                        console.error('âŒ å¤„ç†è§†é¢‘ç‚¹å‡»å¤±è´¥:', error);
                        promptAction.showToast({ message: 'åŠ è½½è§†é¢‘å¤±è´¥ï¼Œè¯·é‡è¯•' });
                        // å¦‚æœå¤„ç†å¤±è´¥ï¼Œå›é€€åˆ°åŸæ¥çš„æ–¹å¼
                        router.pushUrl({ url: "pages/VideoPlayer", params: { bvidflag: item.bvid } });
                      }
                    })
                  .borderRadius(8)
                  .width('100%')
                  .backgroundColor(Color.White)
                  .shadow({ radius: 4, color: '#00000015', offsetX: 0, offsetY: 2 });
                }
                .margin({ bottom: 12 });
              });
            }
            .onReachEnd(() => {
                // é¦–é¡µå§‹ç»ˆåŠ è½½æ¨èå†…å®¹ï¼Œä¸å—æ¨¡å¼å½±å“
                if (this.hasMore && !this.isLoading) {
                  if (this.userToken) {
                    this.loadRecommendVideos();
                  } else {
                    this.loadData();
                  }
                }
              })
            .cachedCount(6)
            .lanes(2, 5)
            .width("100%")
            .edgeEffect(EdgeEffect.Spring)
            // .edgeEffect(EdgeEffect.None)//å¬è¯´å¯ä»¥é˜²æ­¢åå¼¹äºŒæ¬¡è§¦å‘
            .nestedScroll({
              scrollForward: NestedScrollMode.PARENT_FIRST,
              scrollBackward: NestedScrollMode.SELF_FIRST
            });

          }.tabBar("æ¨è")


          TabContent() {
          }.tabBar("çƒ­é—¨");
          TabContent() {
          }.tabBar("åŠ¨ç”»");
          TabContent() {
          }.tabBar("å½±è§†");
          TabContent() {
          }.tabBar("æ–°å¾ç¨‹");
          TabContent() {
          }.tabBar("#");

        }
        .onChange((newIndex) => {
          console.log(`å½“å‰é€‰æ‹©çš„Tabç´¢å¼•: ${newIndex}`);
          // åˆ¤æ–­æ˜¯å¦åˆ‡æ¢åˆ°"æ¨è"æ ‡ç­¾
          if (newIndex === 1) { // å‡è®¾"æ¨è"å¯¹åº”ç´¢å¼•ä¸º1
            this.onReachEnd()
            console.log("åˆ‡æ¢åˆ°æ¨èæ ‡ç­¾ï¼Œå¼€å§‹åˆ·æ–°æ•°æ®");

          }
        })
        .padding({ left: 5, right: 5 })
        .vertical(false)
        .height("100%");
      }.width("100%");
    }
    .edgeEffect(EdgeEffect.Spring)
    .friction(0.6)
    .backgroundColor('#DCDCDC')
    .scrollBar(BarState.Off)
    .width('100%')
    .height('100%');
  }

  // é¢„åŠ è½½å•ä¸ªæ¨èè§†é¢‘çš„æ’­æ”¾é“¾æ¥
  private async preloadSingleRecommendedVideo(video: VideoData): Promise<void> {
    try {
      // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æœ‰æ•ˆçš„æ’­æ”¾é“¾æ¥
      if (video.video && typeof video.video === 'string' && video.video.startsWith('http')) {
        console.log(`âš¡ æ¨èè§†é¢‘ ${video.bvid} å·²æœ‰æ’­æ”¾é“¾æ¥ï¼Œè·³è¿‡é¢„åŠ è½½`);
        return;
      }
      
      // ä½¿ç”¨å½“å‰çš„tokenè¿›è¡Œé‰´æƒ
      if (!this.userToken) {
        console.error(`âŒ Tokenä¸å­˜åœ¨ï¼Œæ— æ³•é¢„åŠ è½½æ¨èè§†é¢‘ ${video.bvid}`);
        return;
      }
      
      console.log(`ğŸ”„ å¼€å§‹é¢„åŠ è½½æ¨èè§†é¢‘: ${video.description} (${video.bvid})`);
      
      // ä½¿ç”¨generate-download-link APIè·å–çœŸæ­£å¯æ’­æ”¾çš„é“¾æ¥
      const fileName = `${video.bvid}.mp4`;
      const response = await apiService.generateDownloadLink(this.userToken, fileName);
      
      if (response && response.downloadUrl) {
        // å°†è·å–åˆ°çš„æ’­æ”¾é“¾æ¥å­˜å‚¨åˆ°è§†é¢‘æ•°æ®ä¸­
        video.video = response.downloadUrl;
        
        console.log(`âœ… æ¨èè§†é¢‘ ${video.bvid} é¢„åŠ è½½æˆåŠŸï¼Œæ’­æ”¾é“¾æ¥: ${response.downloadUrl}`);
        console.log(`ğŸ”‘ ä¸‹è½½token: ${response.token}`);
        console.log(`â° é“¾æ¥è¿‡æœŸæ—¶é—´: ${response.expiresAt}`);
        
        // é€šçŸ¥æ’­æ”¾é¡µé¢è§†é¢‘è§£æå®Œæˆ
        AppStorage.setOrCreate('parsedVideoUpdate', {
          bvid: video.bvid,
          timestamp: Date.now(),
          downloadUrl: response.downloadUrl,
          token: response.token,
          expiresAt: response.expiresAt
        });
      } else {
        console.warn(`âš ï¸ æ¨èè§†é¢‘ ${video.bvid} é¢„åŠ è½½å¤±è´¥ï¼šAPIè¿”å›æ•°æ®å¼‚å¸¸`);
        console.warn(`ğŸ“‹ APIå“åº”:`, response);
      }
    } catch (error) {
      console.error(`âŒ æ¨èè§†é¢‘ ${video.bvid} é¢„åŠ è½½å¤±è´¥:`, error);
      
      // é¢„åŠ è½½å¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹ï¼Œç»§ç»­å¤„ç†å…¶ä»–è§†é¢‘
      if (video.video && typeof video.video === 'string' && !video.video.startsWith('http')) {
        console.log(`ğŸ”„ å°è¯•ä½¿ç”¨åŸæœ‰ä¸‹è½½é“¾æ¥: ${video.video}`);
        // ä¿æŒåŸæœ‰é“¾æ¥ä¸å˜
      }
    }
  }
  
  // å¼‚æ­¥è§£ææ¨èè§†é¢‘ - è°ƒç”¨/video/processæ¥å£è¿›è¡ŒçœŸæ­£çš„è§†é¢‘è§£æ
  private async processRecommendedVideoAsync(videoUrl: string, bvid: string, videoList: VideoData[]): Promise<void> {
    try {
      console.log(`ğŸ”„ å¼€å§‹å¼‚æ­¥è§£ææ¨èè§†é¢‘: ${bvid}`);
      console.log(`ğŸ”— è§†é¢‘URL: ${videoUrl}`);
      
      // æ£€æŸ¥token
      if (!this.userToken) {
        console.error(`âŒ Tokenä¸å­˜åœ¨ï¼Œæ— æ³•è§£æè§†é¢‘ ${bvid}`);
        return;
      }
      
      // è°ƒç”¨/video/processæ¥å£è¿›è¡Œè§†é¢‘è§£æ
      console.log(`ğŸš€ è°ƒç”¨/video/processæ¥å£è§£æè§†é¢‘: ${bvid}`);
      const processResponse = await apiService.processVideo(this.userToken, videoUrl, 80, 'auto');
      
      if (processResponse && processResponse.playUrl) {
        console.log(`âœ… è§†é¢‘è§£ææˆåŠŸ: ${bvid}`);
        console.log(`ğŸ”— æ’­æ”¾é“¾æ¥: ${processResponse.playUrl}`);
        console.log(`ğŸ“‹ è§†é¢‘æ ‡é¢˜: ${processResponse.title}`);
        console.log(`ğŸ“ æ–‡ä»¶è·¯å¾„: ${processResponse.filePath}`);
        console.log(`ğŸ¬ è´¨é‡æè¿°: ${processResponse.qualityDesc}`);
        
        // æ›´æ–°ç¬¬ä¸€ä¸ªè§†é¢‘ï¼ˆç‚¹å‡»çš„æ¨èè§†é¢‘ï¼‰çš„æ’­æ”¾é“¾æ¥å’Œä¿¡æ¯
        if (videoList.length > 0 && videoList[0].bvid === bvid) {
          // è®¾ç½®å®é™…çš„æ’­æ”¾é“¾æ¥
          videoList[0].video = processResponse.playUrl;
          // æ›´æ–°è§†é¢‘æ ‡é¢˜ï¼ˆå¦‚æœAPIè¿”å›äº†æ›´å‡†ç¡®çš„æ ‡é¢˜ï¼‰
          if (processResponse.title) {
            videoList[0].description = processResponse.title;
          }
          
          console.log(`ğŸ¯ å·²æ›´æ–°ç‚¹å‡»è§†é¢‘çš„æ’­æ”¾é“¾æ¥: ${bvid}`);
        }
        
        // é€šçŸ¥æ’­æ”¾é¡µé¢è§†é¢‘è§£æå®Œæˆ
        AppStorage.setOrCreate('parsedVideoUpdate', {
          bvid: bvid,
          timestamp: Date.now(),
          downloadUrl: processResponse.playUrl,
          title: processResponse.title,
          filePath: processResponse.filePath,
          qualityDesc: processResponse.qualityDesc,
          message: processResponse.message
        });
        
        console.log(`ğŸ‰ æ¨èè§†é¢‘ ${bvid} è§£æå®Œæˆï¼Œå·²é€šçŸ¥æ’­æ”¾é¡µé¢`);
        
      } else {
        console.warn(`âš ï¸ è§†é¢‘è§£æå¤±è´¥ï¼šAPIè¿”å›æ•°æ®å¼‚å¸¸ ${bvid}`);
        console.warn(`ğŸ“‹ APIå“åº”:`, processResponse);
      }
      
    } catch (error) {
      console.error(`âŒ å¼‚æ­¥è§£æè§†é¢‘å¤±è´¥: ${bvid}`, error);
      
      // è§£æå¤±è´¥æ—¶çš„å¤„ç†
      if (videoList.length > 0 && videoList[0].bvid === bvid) {
        console.log(`ğŸ”„ è§£æå¤±è´¥ï¼Œè§†é¢‘å°†ä¿æŒæ— æ’­æ”¾é“¾æ¥çŠ¶æ€ï¼Œç­‰å¾…ç”¨æˆ·é‡è¯•`);
      }
    }
  }
  
  // å¼‚æ­¥è§£ææ¨èè§†é¢‘ - ä½¿ç”¨ä¸Dynamic.etsç›¸åŒçš„æ–¹æ³•ï¼ˆä¿ç•™åŸæ–¹æ³•ä½œä¸ºå¤‡ç”¨ï¼‰
  private async parseRecommendedVideoAsync(bvid: string, videoList: VideoData[]): Promise<void> {
    try {
      console.log(`ğŸ”„ å¼€å§‹å¼‚æ­¥è§£ææ¨èè§†é¢‘: ${bvid}`);
      
      // æ£€æŸ¥token
      if (!this.userToken) {
        console.error(`âŒ Tokenä¸å­˜åœ¨ï¼Œæ— æ³•è§£æè§†é¢‘ ${bvid}`);
        return;
      }
      
      // ä½¿ç”¨ä¸Dynamic.etsç›¸åŒçš„æ–¹æ³•ï¼šgenerateDownloadLink APIè·å–çœŸæ­£å¯æ’­æ”¾çš„é“¾æ¥
      const fileName = `${bvid}.mp4`;
      const response = await apiService.generateDownloadLink(this.userToken, fileName);
      
      if (response && response.downloadUrl) {
        console.log(`âœ… è§†é¢‘è§£ææˆåŠŸ: ${bvid}`);
        console.log(`ğŸ”— æ’­æ”¾é“¾æ¥: ${response.downloadUrl}`);
        console.log(`ğŸ”‘ ä¸‹è½½token: ${response.token}`);
        console.log(`â° é“¾æ¥è¿‡æœŸæ—¶é—´: ${response.expiresAt}`);
        
        // æ›´æ–°ç¬¬ä¸€ä¸ªè§†é¢‘ï¼ˆç‚¹å‡»çš„æ¨èè§†é¢‘ï¼‰çš„æ’­æ”¾é“¾æ¥
        if (videoList.length > 0 && videoList[0].bvid === bvid) {
          // è®¾ç½®å®é™…çš„æ’­æ”¾é“¾æ¥
          videoList[0].video = response.downloadUrl;
          
          console.log(`ğŸ¯ å·²æ›´æ–°ç‚¹å‡»è§†é¢‘çš„æ’­æ”¾é“¾æ¥: ${bvid}`);
        }
        
        // é€šçŸ¥æ’­æ”¾é¡µé¢è§†é¢‘è§£æå®Œæˆ
        AppStorage.setOrCreate('parsedVideoUpdate', {
          bvid: bvid,
          timestamp: Date.now(),
          downloadUrl: response.downloadUrl,
          token: response.token,
          expiresAt: response.expiresAt
        });
        
      } else {
        console.warn(`âš ï¸ è§†é¢‘è§£æå¤±è´¥ï¼šAPIè¿”å›æ•°æ®å¼‚å¸¸ ${bvid}`);
        console.warn(`ğŸ“‹ APIå“åº”:`, response);
      }
      
    } catch (error) {
      console.error(`âŒ å¼‚æ­¥è§£æè§†é¢‘å¤±è´¥: ${bvid}`, error);
      
      // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åŸæœ‰çš„ä¸‹è½½é“¾æ¥ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
      if (videoList.length > 0 && videoList[0].bvid === bvid) {
        console.log(`ğŸ”„ è§£æå¤±è´¥ï¼Œä¿æŒåŸæœ‰é“¾æ¥`);
      }
    }
  }
}
