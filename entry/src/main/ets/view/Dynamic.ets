import { MyDataSource } from '../Model/MyDataSource';
import { VideoData } from '../Model/VideoData';
import { apiService } from '../api/ApiService';
import { tokenManager } from '../utils/TokenManager';
import http from '@ohos.net.http';
import { promptAction, router } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';
import { preferences } from '@kit.ArkData';



/*
 *
 * 1. top: { anchor: "row3", align: VerticalAlign.Bottom }
anchor: "row3"ï¼šè¿™ä¸ªå‚æ•°æŒ‡æ˜äº†å½“å‰ç»„ä»¶çš„ä¸Šè¾¹ç¼˜å°†ä¸åä¸º row3 çš„ç»„ä»¶å¯¹é½ã€‚
align: VerticalAlign.Bottomï¼šå½“å‰ç»„ä»¶çš„ä¸Šè¾¹ç¼˜å°†å¯¹é½åˆ° row3 çš„åº•éƒ¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å‰ç»„ä»¶çš„é¡¶éƒ¨å°†ä½äº row3 çš„åº•éƒ¨ä½ç½®ã€‚
2. bottom: { anchor: "__container__", align: VerticalAlign.Bottom }
anchor: "__container__"ï¼šè¿™é‡Œä½¿ç”¨äº† __container__ ä½œä¸ºé”šç‚¹ï¼Œè¡¨ç¤ºå½“å‰ç»„ä»¶çš„åº•éƒ¨å°†ä¸å…¶çˆ¶å®¹å™¨çš„åº•éƒ¨å¯¹é½ã€‚
align: VerticalAlign.Bottomï¼šå½“å‰ç»„ä»¶çš„åº•éƒ¨å°†å¯¹é½åˆ°å®¹å™¨çš„åº•éƒ¨è¾¹ç¼˜ã€‚
3. left: { anchor: "__container__", align: HorizontalAlign.Start }
anchor: "__container__"ï¼šå½“å‰ç»„ä»¶çš„å·¦è¾¹ç¼˜å°†ä¸çˆ¶å®¹å™¨çš„å·¦è¾¹ç¼˜å¯¹é½ã€‚
align: HorizontalAlign.Startï¼šè¿™è¡¨ç¤ºå½“å‰ç»„ä»¶çš„å·¦è¾¹ç¼˜å°†å¯¹é½åˆ°å®¹å™¨çš„å·¦ä¾§å¼€å§‹ä½ç½®ã€‚
4. right: { anchor: "row1", align: HorizontalAlign.End }
anchor: "row1"ï¼šå½“å‰ç»„ä»¶çš„å³è¾¹ç¼˜å°†ä¸åä¸º row1 çš„ç»„ä»¶å¯¹é½ã€‚
align: HorizontalAlign.Endï¼šè¿™è¡¨ç¤ºå½“å‰ç»„ä»¶çš„å³è¾¹ç¼˜å°†å¯¹é½åˆ° row1 çš„å³è¾¹ç¼˜ã€‚
* */
// å®šä¹‰ç”¨æˆ·è§†é¢‘ä¿¡æ¯æ¥å£
export interface UserVideoInfo {
  id: number;
  bvid: string;
  title: string;
  pic: string;
  duration: string;
  view: string;
  danmaku: string;
  like: string;
  coin: string;
  share: string;
  favorite: string;
  reply: string;
  owner_name: string;
  owner_face: string;
  pubdate: string;
  tname: string;
  download_link: string;
  file_size?: number;
  current_viewers?: string;
  quality: string;
  aid: string;
  desc: string;
  name: string;
  face: string;
  cid: string;
  relation_type: string;
  relation_created_at: string;
  relation_desc: string;
  preloaded_url?: string;
  preloaded_audio?: string;
}

// å®šä¹‰APIå“åº”æ¥å£
interface UserVideoListResponse {
  videos: Array<UserVideoInfo>;
  total: number;
  page: number;
  has_more: boolean;
}

@Component
export struct Dynamic {
  private myController: VideoController = new VideoController();
  private datas: MyDataSource = new MyDataSource();
  private cachedVideos: Array<VideoData> = []; // ç¼“å­˜çš„è§†é¢‘æ•°æ®
  private preloadedVideos: Set<string> = new Set(); // å·²é¢„åŠ è½½çš„è§†é¢‘BVID
  @State index: number = 0;
  @State currentPage: number = 1;
  @State isLoading: boolean = false;
  @State hasMore: boolean = true;
  @State userToken: string = '';
  @State totalVideos: number = 0;
  @State selectedVideoIndex: number = -1; // å½“å‰é€‰ä¸­çš„è§†é¢‘ç´¢å¼•
  @State bottomTabIndex: number = 1;
  @State errorMessage: string = '';
  @State isRefreshing: boolean = false;
  @State loadingMore: boolean = false; // æ˜¯å¦æ­£åœ¨åŠ è½½æ›´å¤š
  @Styles
  listCard() {
    .backgroundColor(Color.White)
    .height(72)
    .width("100%")
    .borderRadius(12)
  }

  private getUIAbilityContext(): common.UIAbilityContext {
    return AppStorage.get('uiAbilityContext') as common.UIAbilityContext;
  }

  async aboutToAppear() {
    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿UIAbilityContextå·²ç»è®¾ç½®å®Œæˆ
    setTimeout(async () => {
      await this.loadUserToken();
      await this.loadUserVideos();
    }, 100);
  }

  // åŠ è½½ç”¨æˆ·Token
  async loadUserToken() {
    try {
      // ä¼˜å…ˆæ£€æŸ¥AppStorageä¸­æ˜¯å¦æœ‰å·²éªŒè¯çš„token
      const verifiedToken = AppStorage.get('verifiedToken') as string;
      const tokenVerified = AppStorage.get('tokenVerified') as boolean;
      
      if (verifiedToken && tokenVerified) {
        console.log('ğŸ¯ å‘ç°å·²éªŒè¯çš„tokenï¼Œç›´æ¥ä½¿ç”¨');
        this.userToken = verifiedToken;
        return;
      }
      
      // ä»æœ¬åœ°å­˜å‚¨è·å–token
      const context = this.getUIAbilityContext();
      if (context) {
        const token = await tokenManager.getToken(context);
        if (token) {
          this.userToken = token;
          console.log('âœ… æˆåŠŸè·å–ç”¨æˆ·token');
        } else {
          console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·token');
          this.errorMessage = 'è¯·å…ˆç™»å½•è´¦å·';
        }
      }
    } catch (error) {
      console.error('âŒ è·å–ç”¨æˆ·tokenå¤±è´¥:', error);
      this.errorMessage = 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥';
    }
  }

  // åŠ è½½ç”¨æˆ·è§†é¢‘åˆ—è¡¨
  async loadUserVideos(isLoadMore: boolean = false) {
    if (this.isLoading || (!this.hasMore && isLoadMore)) {
      return;
    }

    if (!this.userToken) {
      this.errorMessage = 'è¯·å…ˆç™»å½•è´¦å·';
      return;
    }

    this.isLoading = true;
    this.errorMessage = '';

    try {
      // è°ƒç”¨åç«¯APIè·å–ç”¨æˆ·è§†é¢‘åˆ—è¡¨
      const response = await this.getUserVideosFromAPI(this.currentPage, 20);
      
      if (response && response.videos) {
        const newVideos = this.convertToVideoData(response.videos);
        
        if (isLoadMore) {
          // åŠ è½½æ›´å¤šæ—¶è¿½åŠ åˆ°ç°æœ‰æ•°æ®
          newVideos.forEach(video => {
            this.datas.pushData(video);
            this.cachedVideos.push(video);
          });
        } else {
          // é¦–æ¬¡åŠ è½½æˆ–åˆ·æ–°æ—¶æ›¿æ¢æ•°æ®
          this.datas.clearData();
          this.cachedVideos = [];
          newVideos.forEach(video => {
            this.datas.pushData(video);
            this.cachedVideos.push(video);
          });
        }
        
        this.totalVideos = response.total;
        this.hasMore = response.has_more;
        this.currentPage = response.page + 1;
        
        // é¢„åŠ è½½å‰å5ä¸ªè§†é¢‘
        this.preloadNearbyVideos();
      }
    } catch (error) {
      console.error('âŒ åŠ è½½ç”¨æˆ·è§†é¢‘å¤±è´¥:', error);
      this.errorMessage = 'åŠ è½½è§†é¢‘åˆ—è¡¨å¤±è´¥ï¼Œè¯·é‡è¯•';
    } finally {
      this.isLoading = false;
      this.isRefreshing = false;
    }
  }

  // è·å–ç”¨æˆ·è§†é¢‘æ•°æ®çš„APIè°ƒç”¨
  private async getUserVideosFromAPI(page: number, pageSize: number = 20): Promise<UserVideoListResponse> {
    try {
      // è°ƒç”¨çœŸå®çš„APIè·å–ç”¨æˆ·è§†é¢‘åˆ—è¡¨
      const videos = await apiService.getUserVideos(this.userToken);
      
      // è½¬æ¢APIå“åº”ä¸ºUserVideoListResponseæ ¼å¼
      const response: UserVideoListResponse = {
        videos: videos.map((item): UserVideoInfo => ({
          id: item.id,
          bvid: item.bvid,
          title: item.title,
          pic: item.pic,
          duration: item.duration || '0',
          view: item.view || '0',
          danmaku: item.danmaku || '0',
          like: item.like || '0',
          coin: item.coin || '0',
          share: item.share || '0',
          favorite: item.favorite || '0',
          reply: item.reply || '0',
          owner_name: item.name,
          owner_face: item.face,
          pubdate: item.pubdate || '0',
          tname: item.tname,
          download_link: item.download_link,
          current_viewers: item.current_viewers || '0',
          quality: item.quality || '',
          aid: item.aid || '',
          desc: item.desc || '',
          name: item.name,
          face: item.face,
          cid: item.cid || '',
          relation_type: item.relation_type || '',
          relation_created_at: item.relation_created_at || '',
          relation_desc: item.relation_desc || ''
        })),
        total: videos.length,
        page: page,
        has_more: false // ç›®å‰APIè¿”å›æ‰€æœ‰æ•°æ®ï¼Œæ²¡æœ‰åˆ†é¡µ
      };
      
      return response;
    } catch (error) {
      console.error('è·å–ç”¨æˆ·è§†é¢‘åˆ—è¡¨å¤±è´¥:', error);
      // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œè¿”å›ç©ºæ•°æ®
      return {
        videos: [],
        total: 0,
        page: page,
        has_more: false
      };
    }
  }

  // è½¬æ¢APIæ•°æ®ä¸ºVideoDataæ ¼å¼
  private convertToVideoData(videos: Array<UserVideoInfo>): Array<VideoData> {
    return videos.map((item, index) => {
      const videoData: VideoData = {
        description: item.title,
        head: item.pic,
        video: item.download_link,
        bvid: item.bvid,
        name: item.owner_name,
        face: item.owner_face,
        view: item.view,
        like: item.like,
        barrage: item.danmaku,
        time: item.duration,
        pubdate: item.pubdate,
        coins: String(item.coin),
        favorites: String(item.favorite),
        shares: String(item.share),
        controller: this.myController,
        auto: true,
        play: false,
        index: String(this.cachedVideos.length + index)
      };
      return videoData;
    });
  }

  // é¢„åŠ è½½å‰å5ä¸ªè§†é¢‘
  private preloadNearbyVideos() {
    const currentIndex = this.selectedVideoIndex >= 0 ? this.selectedVideoIndex : 0;
    const startIndex = Math.max(0, currentIndex - 5);
    const endIndex = Math.min(this.cachedVideos.length - 1, currentIndex + 5);
    
    for (let i = startIndex; i <= endIndex; i++) {
      const video = this.cachedVideos[i];
      if (video && !this.preloadedVideos.has(video.bvid)) {
        this.preloadVideo(video);
        this.preloadedVideos.add(video.bvid);
      }
    }
  }

  // é¢„åŠ è½½å•ä¸ªè§†é¢‘
  private preloadVideo(video: VideoData) {
    // è¿™é‡Œå¯ä»¥å®ç°è§†é¢‘é¢„åŠ è½½é€»è¾‘
    // ä¾‹å¦‚é¢„åŠ è½½è§†é¢‘çš„ç¬¬ä¸€å¸§æˆ–è€…ç¼“å­˜è§†é¢‘å…ƒæ•°æ®
    console.log(`ğŸ¬ é¢„åŠ è½½è§†é¢‘: ${video.description}`);
  }

  // è§†é¢‘ç‚¹å‡»å¤„ç† - å°†é€‰ä¸­è§†é¢‘ç§»åˆ°ç¬¬ä¸€ä½
  private async onVideoClick(clickedVideo: VideoData, clickedIndex: number) {
    console.log(`ğŸ¯ ç‚¹å‡»è§†é¢‘: ${clickedVideo.description}`);
    
    try {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      this.isLoading = true;
      
      // è·å–å…¨éƒ¨è§†é¢‘æ•°æ®ï¼ˆè€Œä¸æ˜¯ä½¿ç”¨ç¼“å­˜çš„è§†é¢‘ï¼‰
      const allVideosResponse = await this.getUserVideosFromAPI(1, 100); // è·å–æ›´å¤šè§†é¢‘
      const allVideos = this.convertToVideoData(allVideosResponse.videos);
      
      // æ‰¾åˆ°ç‚¹å‡»çš„è§†é¢‘åœ¨å…¨éƒ¨è§†é¢‘ä¸­çš„ç´¢å¼•
      const actualClickedIndex = allVideos.findIndex(video => video.bvid === clickedVideo.bvid);
      const startIndex = actualClickedIndex >= 0 ? actualClickedIndex : 0;
      
      // é‡æ–°æ’åºè§†é¢‘åˆ—è¡¨ï¼Œå°†ç‚¹å‡»çš„è§†é¢‘æ”¾åœ¨ç¬¬ä¸€ä½
      const reorderedVideos = this.reorderAllVideos(allVideos, startIndex);
      
      // é¢„åŠ è½½å‰5ä¸ªè§†é¢‘çš„æ’­æ”¾é“¾æ¥ï¼ˆé‰´æƒä½†ä¸æ’­æ”¾ï¼‰
      await this.preloadVideoLinksWithAuth(reorderedVideos.slice(0, 5));
      
      // è®¾ç½®é€‰ä¸­çš„è§†é¢‘ç´¢å¼•
      this.selectedVideoIndex = startIndex;
      
      // è·³è½¬åˆ°è§†é¢‘æ’­æ”¾é¡µé¢
      router.pushUrl({
        url: "pages/VideoPlayer",
        params: {
          videoDatas: reorderedVideos,
          bvidflag: clickedVideo.bvid,
          startIndex: 0, // ä»é‡æ’åçš„ç¬¬ä¸€ä¸ªå¼€å§‹æ’­æ”¾
          preloadedCount: 5 // å·²é¢„åŠ è½½çš„è§†é¢‘æ•°é‡
        }
      });
      
    } catch (error) {
      console.error('åŠ è½½è§†é¢‘å¤±è´¥:', error);
      this.errorMessage = 'åŠ è½½è§†é¢‘å¤±è´¥ï¼Œè¯·é‡è¯•';
    } finally {
      this.isLoading = false;
    }
  }

  // é‡æ–°æ’åºè§†é¢‘åˆ—è¡¨
  private reorderVideos(clickedIndex: number): Array<VideoData> {
    const allVideos = this.datas.getAllData();
    const clickedVideo = allVideos[clickedIndex];
    const otherVideos = allVideos.filter((_, index) => index !== clickedIndex);
    
    // å°†ç‚¹å‡»çš„è§†é¢‘æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œå…¶ä»–è§†é¢‘ä¿æŒåŸæœ‰é¡ºåº
    const reorderedVideos = [clickedVideo, ...otherVideos];
    
    // æ›´æ–°æ•°æ®æº
    this.datas.clearData();
    this.cachedVideos = [];
    reorderedVideos.forEach(video => {
      this.datas.pushData(video);
      this.cachedVideos.push(video);
    });
    
    return reorderedVideos;
  }
  
  // é‡æ–°æ’åºå…¨éƒ¨è§†é¢‘åˆ—è¡¨
  private reorderAllVideos(allVideos: Array<VideoData>, clickedIndex: number): Array<VideoData> {
    if (clickedIndex < 0 || clickedIndex >= allVideos.length) {
      return allVideos;
    }
    
    const clickedVideo = allVideos[clickedIndex];
    const otherVideos = allVideos.filter((_, index) => index !== clickedIndex);
    
    return [clickedVideo, ...otherVideos];
  }
  
  // é¢„åŠ è½½è§†é¢‘é“¾æ¥å¹¶è¿›è¡Œé‰´æƒ
  private async preloadVideoLinksWithAuth(videos: Array<VideoData>): Promise<void> {
    console.log(`ğŸ”„ å¼€å§‹é¢„åŠ è½½ ${videos.length} ä¸ªè§†é¢‘çš„æ’­æ”¾é“¾æ¥`);
    
    const preloadPromises = videos.map(async (video, index) => {
      try {
        // è°ƒç”¨APIè·å–è§†é¢‘æ’­æ”¾é“¾æ¥ï¼ˆé‰´æƒï¼‰
        const token = await tokenManager.getToken(getContext(this) as common.UIAbilityContext);
        if (!token) {
          console.error('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•é¢„åŠ è½½è§†é¢‘');
          return;
        }
        const response = await apiService.parseVideo(token, video.bvid);
        if (response && response.play_info) {
          // å°†é‰´æƒåçš„æ’­æ”¾é“¾æ¥å­˜å‚¨åˆ°è§†é¢‘æ•°æ®ä¸­
          video.video = response.play_info?.video_url || '';
          console.log(`âœ… è§†é¢‘ ${video.bvid} é¢„åŠ è½½å®Œæˆ`);
        }
      } catch (error) {
        console.error(`âŒ è§†é¢‘ ${video.bvid} é¢„åŠ è½½å¤±è´¥:`, error);
      }
    });
    
    // ç­‰å¾…æ‰€æœ‰é¢„åŠ è½½å®Œæˆ
    await Promise.allSettled(preloadPromises);
    console.log(`ğŸ‰ é¢„åŠ è½½å®Œæˆ`);
  }

  // åˆ·æ–°è§†é¢‘åˆ—è¡¨
  private async refreshVideoList() {
    this.isRefreshing = true;
    this.currentPage = 1;
    this.hasMore = true;
    this.preloadedVideos.clear();
    await this.loadUserVideos(false);
  }

  // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º
  private formatNumber(num: number): string {
    if (num >= 100000000) {
      return (num / 100000000).toFixed(1) + 'äº¿';
    } else if (num >= 10000) {
      return (num / 10000).toFixed(1) + 'ä¸‡';
    } else {
      return num.toString();
    }
  }

  // æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º
  private formatDuration(seconds: number): string {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
      return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
      return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
  }

  // åˆ—è¡¨åˆ°åº•éƒ¨æ—¶è§¦å‘
  private async onReachEnd() {
    console.log('ğŸ“ è§¦åº•åŠ è½½æ›´å¤š');
    await this.loadUserVideos(true);
  }

  onPageShow(): void {
    this.datas.getData(this.index).controller.start();
  }

  onPageHide(): void {
    this.datas.getData(this.index).controller.pause();
  }

  build() {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æ 
      Row() {
        Text('æˆ‘çš„è§†é¢‘')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
        
        Blank()
        
        if (this.isLoading) {
          LoadingProgress()
            .width(20)
            .height(20)
            .color('#1296db')
        }
      }
      .width('100%')
      .height(50)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#ffffff')
      .border({ width: { bottom: 1 }, color: '#f0f0f0' })

      // é”™è¯¯æç¤º
      if (this.errorMessage) {
        Row() {
          Text(this.errorMessage)
            .fontSize(14)
            .fontColor('#ff4444')
          
          Blank()
          
          Button('é‡è¯•')
            .fontSize(12)
            .backgroundColor('#1296db')
            .fontColor('#ffffff')
            .padding({ left: 12, right: 12, top: 4, bottom: 4 })
            .onClick(() => {
              this.errorMessage = '';
              this.refreshVideoList();
            })
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#fff5f5')
      }

      // è§†é¢‘ç»Ÿè®¡ä¿¡æ¯
      if (this.totalVideos > 0) {
        Row() {
          Text(`å…± ${this.totalVideos} ä¸ªè§†é¢‘`)
            .fontSize(12)
            .fontColor('#666666')
          
          Blank()
          
          if (this.selectedVideoIndex >= 0) {
            Text(`å½“å‰é€‰ä¸­: ç¬¬ ${this.selectedVideoIndex + 1} ä¸ª`)
              .fontSize(12)
              .fontColor('#1296db')
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .backgroundColor('#f8f9fa')
      }

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      if (this.datas.totalCount() === 0 && !this.isLoading) {
        Column() {
          Text('ğŸ“¹')
             .fontSize(60)
             .opacity(0.5)
             .margin({ bottom: 16 })
          
          Text('æš‚æ— è§†é¢‘')
            .fontSize(16)
            .fontColor('#999999')
            .margin({ bottom: 8 })
          
          Text('ä¸‹æ‹‰åˆ·æ–°è¯•è¯•çœ‹')
            .fontSize(14)
            .fontColor('#cccccc')
          
          Button('åˆ·æ–°')
            .fontSize(14)
            .backgroundColor('#1296db')
            .fontColor('#ffffff')
            .margin({ top: 20 })
            .onClick(() => this.refreshVideoList())
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        // è§†é¢‘åˆ—è¡¨ - ç½‘æ ¼å¸ƒå±€ï¼ˆç±»ä¼¼é¦–é¡µï¼‰
        Refresh({ refreshing: this.isRefreshing }) {
          List({ space: 5 }) {
            LazyForEach(this.datas, (item: VideoData, index: number) => {
              ListItem() {
                Column() {
                  // å›¾ç‰‡å®¹å™¨
                  Stack() {
                    Image(item.head || '')
                      .width('100%')
                      .height(130)
                      .objectFit(ImageFit.Cover)
                      .borderRadius({ topLeft: 8, topRight: 8 })

                    // åº•éƒ¨ä¿¡æ¯æ ï¼šæ’­æ”¾é‡å¼¹å¹•åœ¨å·¦ï¼Œæ—¶é•¿åœ¨å³
                    Row() {
                      // æ’­æ”¾é‡å’Œå¼¹å¹•æ•°åœ¨å·¦ä¾§
                      Row() {
                        if (Number(item.view) > 0) {
                          Text(`${this.formatNumber(Number(item.view))}æ’­æ”¾`)
                            .fontSize(11)
                            .fontColor(Color.White)
                            .margin({ right: 8 })
                        }
                        if (Number(item.barrage) > 0) {
                          Text(`${this.formatNumber(Number(item.barrage))}å¼¹å¹•`)
                            .fontSize(11)
                            .fontColor(Color.White)
                        }
                      }
                      .backgroundColor('rgba(0, 0, 0, 0.7)')
                      .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                      .borderRadius(4)
                      
                      Blank()
                      
                      // æ—¶é•¿åœ¨å³ä¾§
                      if (Number(item.time) > 0) {
                        Text(this.formatDuration(Number(item.time)))
                          .fontSize(11)
                          .fontColor(Color.White)
                          .backgroundColor('rgba(0, 0, 0, 0.7)')
                          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                          .borderRadius(4)
                      }
                    }
                    .width('100%')
                    .padding({ left: 2, right: 2, bottom: 2 })
                    .position({ x: 0, y: '100%' })
                    .translate({ x: 0, y: -2 })
                    .markAnchor({ x: 0, y: '100%' })
                    
                    // é€‰ä¸­æ ‡è¯†
                    if (this.selectedVideoIndex === index) {
                      Row() {
                        Text('âœ“')
                          .fontSize(12)
                          .fontColor('#1296db')
                          .fontWeight(FontWeight.Bold)
                      }
                      .width(24)
                      .height(24)
                      .backgroundColor('#ffffff')
                      .borderRadius(12)
                      .justifyContent(FlexAlign.Center)
                      .position({ x: 6, y: 6 })
                    }
                  }
                  .width('100%')
                  .height(130)
                  
                  // è§†é¢‘ä¿¡æ¯åŒºåŸŸ
                  Column() {
                    // è§†é¢‘æ ‡é¢˜
                    Text(item.description || 'æ— æ ‡é¢˜')
                      .fontSize(14)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#333333')
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .lineHeight(20)
                      .width('100%')
                      .height(48)  // å›ºå®šé«˜åº¦ï¼š20pxè¡Œé«˜ Ã— 2è¡Œ + 8pxé—´è·
                      .margin({ bottom: 8 })
                    
                    // ä½œè€…ä¿¡æ¯å’Œåˆ†ç±»æ ‡ç­¾
                    Row() {
                      Text(item.name || 'æœªçŸ¥UPä¸»')
                        .fontSize(12)
                        .fontColor('#666666')
                        .fontWeight(FontWeight.Normal)
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                        .layoutWeight(1)
                      
                      if (item.tname && item.tname !== '') {
                        Text(item.tname)
                          .fontSize(10)
                          .fontColor('#FB7299')
                          .backgroundColor('#FFF0F5')
                          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                          .borderRadius(10)
                      }
                    }
                    .width('100%')
                  }
                  .padding({ left: 12, right: 12, top: 10, bottom: 12 })
                  .alignItems(HorizontalAlign.Start)
                  .backgroundColor(Color.White)
                  .borderRadius({ bottomLeft: 8, bottomRight: 8 })
                }
                .onClick(() => this.onVideoClick(item, index))
                .borderRadius(8)
                .width('100%')
                .backgroundColor(Color.White)
                .shadow({ radius: 4, color: '#00000015', offsetX: 0, offsetY: 2 })
              }
              .margin({ bottom: 12 })
            }, (item: VideoData) => item.bvid)
            
            // åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨
            if (this.hasMore && this.datas.totalCount() > 0) {
              ListItem() {
                Row() {
                  if (this.loadingMore) {
                    LoadingProgress()
                      .width(20)
                      .height(20)
                      .color('#1296db')
                      .margin({ right: 8 })
                    Text('åŠ è½½ä¸­...')
                      .fontSize(14)
                      .fontColor('#666666')
                  } else {
                    Text('ä¸Šæ‹‰åŠ è½½æ›´å¤š')
                      .fontSize(14)
                      .fontColor('#999999')
                  }
                }
                .width('100%')
                .height(50)
                .justifyContent(FlexAlign.Center)
              }
            } else if (!this.hasMore && this.datas.totalCount() > 0) {
              ListItem() {
                Text('å·²åŠ è½½å…¨éƒ¨è§†é¢‘')
                  .fontSize(14)
                  .fontColor('#cccccc')
                  .width('100%')
                  .height(50)
                  .textAlign(TextAlign.Center)
              }
            }
          }
          .width('100%')
          .height('100%')
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .onReachEnd(() => this.onReachEnd())
          .cachedCount(10)
          .lanes(2, 5)
          .scrollBar(BarState.Auto)
          .edgeEffect(EdgeEffect.Spring)
          .nestedScroll({
            scrollForward: NestedScrollMode.PARENT_FIRST,
            scrollBackward: NestedScrollMode.SELF_FIRST
          })
        }
        .onRefreshing(() => this.refreshVideoList())
        .refreshOffset(64)
        .pullToRefresh(true)
        .padding({ left: 5, right: 5 })
        .backgroundColor('#DCDCDC')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }
}
