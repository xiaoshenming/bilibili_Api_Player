import { CommonConstants as Const } from '../common/CommonConstants';
import { MyDataSource } from '../Model/MyDataSource';
import { VideoData, BilibiliVideoInfo } from '../Model/VideoData';
import { router, curves, promptAction } from '@kit.ArkUI';
import { webview } from '@kit.ArkWeb';
import { bilibiliService } from '../api/BilibiliService';
import { Side, VideoDes } from '../view/Side';
import { TopTabContent } from '../Model/DataModel';
import { common } from '@kit.AbilityKit';
import { tokenManager } from '../utils/TokenManager';
import { apiService } from '../api/ApiService';
import { UserVideoInfo } from '../view/Dynamic';
let videoIndex: number = 0;

@Entry
@Component
export struct VideoPlayer {
  private swiperController: SwiperController = new SwiperController();
  private myController: VideoController = new VideoController();
  private datas: MyDataSource = new MyDataSource();
  @State playBoo: boolean = true;
  @State localonline: boolean = true;
  @State index: number = 0;
  @State totalindex: string = '111';
  @State currentIndex: number = 1;
  @State mp4: string = '';
  @State isLoading: boolean = false;
  @State fromParse: boolean = false; // æ ‡è¯†æ˜¯å¦æ¥è‡ªè§£æé¡µé¢
  scroller: Scroller = new Scroller();
  private topTabListData: TopTabContent = new TopTabContent();
  private context = getContext(this) as common.UIAbilityContext;

  controller: webview.WebviewController = new webview.WebviewController();
  videoDatas: Array<VideoData> = [];

  // å­˜å‚¨ä¼ é€’çš„ç”¨æˆ·token
  private userToken: string | null = null;
  private preloadedVideos: Set<string> = new Set(); // è®°å½•å·²é¢„åŠ è½½çš„è§†é¢‘
  
  async aboutToAppear() {
    try {
      console.info('VideoPlayerç»„ä»¶å¼€å§‹åˆå§‹åŒ–');
      
      // å®‰å…¨è·å–è·¯ç”±å‚æ•°
      let params: Record<string, Object> = {};
      try {
        params = router.getParams() as Record<string, Object> || {};
        console.info('VideoPlayer params:', JSON.stringify(params));
      } catch (paramError) {
        console.error('è·å–è·¯ç”±å‚æ•°å¤±è´¥:', paramError);
        params = {};
      }
      
      // æ¥æ”¶ä¼ é€’çš„ç”¨æˆ·token
      if (params["userToken"] && typeof params["userToken"] === 'string') {
        this.userToken = params["userToken"] as string;
        console.info('æ¥æ”¶åˆ°ç”¨æˆ·tokenï¼Œé•¿åº¦:', this.userToken.length);
      } else {
        console.info('æœªæ¥æ”¶åˆ°ç”¨æˆ·tokenï¼Œå°†ä½¿ç”¨æœ¬åœ°token');
      }
      
      // æ£€æŸ¥æ˜¯å¦æ¥è‡ªè§£æé¡µé¢
      this.fromParse = Boolean(params["fromParse"]) || false;
      
      // ä¼˜å…ˆå¤„ç†ä¼ å…¥çš„è§†é¢‘æ•°æ®åˆ—è¡¨ï¼ˆæ¥è‡ªDynamicé¡µé¢æˆ–Homeé¡µé¢ï¼‰
      if (params["videoDatas"] && Array.isArray(params["videoDatas"]) && params["videoDatas"].length > 0) {
        console.info('æ£€æµ‹åˆ°ä¼ å…¥çš„è§†é¢‘æ•°æ®åˆ—è¡¨ï¼Œç›´æ¥ä½¿ç”¨');
        try {
          const videoDatas = params["videoDatas"] as VideoData[];
          const startIndex = Number(params["startIndex"]) || 0;
          const fromHome = Boolean(params["fromHome"]) || false;
          const fromDynamic = Boolean(params["fromDynamic"]) || false;
          
          // æ¸…ç©ºé»˜è®¤æ•°æ®ï¼Œä½¿ç”¨ä¼ å…¥çš„è§†é¢‘åˆ—è¡¨
          this.datas.clearData();
          videoDatas.forEach((video, index) => {
            // æ›´æ–°è§†é¢‘ç´¢å¼•
            video.index = index.toString();
            this.datas.pushData(video);
          });
          
          // è®¾ç½®èµ·å§‹æ’­æ”¾ä½ç½®
          this.index = startIndex;
          console.info(`å·²åŠ è½½${videoDatas.length}ä¸ªè§†é¢‘ï¼Œä»ç¬¬${startIndex}ä¸ªå¼€å§‹æ’­æ”¾`);
          
          // ç¡®ä¿å½“å‰è§†é¢‘å¯æ’­æ”¾
          if (this.datas.totalCount() > startIndex) {
            const currentVideo = this.datas.getData(startIndex);
            await this.ensureVideoPlayable(currentVideo, startIndex);
          }
          
          // æ™ºèƒ½é¢„åŠ è½½ç›¸é‚»è§†é¢‘ä»¥å®ç°è¿ç»­æ’­æ”¾
          if (fromDynamic) {
            console.info('æ¥è‡ªDynamicé¡µé¢ï¼Œå¼€å§‹æ™ºèƒ½é¢„åŠ è½½ç›¸é‚»è§†é¢‘');
            await this.smartPreloadAdjacentVideos(startIndex);
          }
          
          // å¦‚æœæ¥è‡ªé¦–é¡µä¸”æœ‰bvidflagï¼Œå¼‚æ­¥è§£ææ›´é«˜è´¨é‡ç‰ˆæœ¬
          if (fromHome && params["bvidflag"]) {
            console.info('æ¥è‡ªé¦–é¡µï¼Œå¼‚æ­¥è§£ææ›´é«˜è´¨é‡ç‰ˆæœ¬');
            this.parseVideoFromParamsAsync(params);
          }
          
        } catch (dataError) {
          console.error('å¤„ç†ä¼ å…¥è§†é¢‘æ•°æ®å¤±è´¥:', dataError);
          // å¦‚æœå¤„ç†å¤±è´¥ï¼Œå›é€€åˆ°è§£ææ¨¡å¼
          await this.handleFallbackMode(params);
        }
      } else {
        // æ²¡æœ‰ä¼ å…¥è§†é¢‘åˆ—è¡¨ï¼Œä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼
        await this.handleFallbackMode(params);
      }
      
      console.info('VideoPlayerç»„ä»¶åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      console.error('VideoPlayerç»„ä»¶åˆå§‹åŒ–å¤±è´¥:', error);
      console.error('åˆå§‹åŒ–é”™è¯¯è¯¦æƒ…:', JSON.stringify(error));
      // ç¡®ä¿å³ä½¿å‡ºé”™ä¹Ÿèƒ½æ˜¾ç¤ºé»˜è®¤è§†é¢‘
      await this.loadHistoryVideosAsBackup();
    }
  }
  
  // å¤„ç†å›é€€æ¨¡å¼ï¼ˆæ²¡æœ‰ä¼ å…¥è§†é¢‘åˆ—è¡¨çš„æƒ…å†µï¼‰
  private async handleFallbackMode(params: Record<string, Object> = {}) {
    console.info('è¿›å…¥å›é€€æ¨¡å¼ï¼Œå…ˆåŠ è½½å†å²è§†é¢‘ä½œä¸ºå¤‡é€‰');
    
    // å…ˆåŠ è½½ç”¨æˆ·çš„å†å²è§†é¢‘ä½œä¸ºå¤‡é€‰å†…å®¹
    await this.loadHistoryVideosAsBackup();
    
    // å¦‚æœæœ‰bvidflagå‚æ•°ï¼Œå¼‚æ­¥è§£æç›®æ ‡è§†é¢‘
    if (params["bvidflag"] && typeof params["bvidflag"] === 'string') {
      console.info('æ£€æµ‹åˆ°bvidflagå‚æ•°ï¼Œå¼‚æ­¥è§£æç›®æ ‡è§†é¢‘');
      // å¼‚æ­¥è§£æï¼Œä¸é˜»å¡ç”¨æˆ·è§‚çœ‹å†å²è§†é¢‘
      this.parseVideoFromParamsAsync(params);
    }
  }

  // ä»å‚æ•°è§£æè§†é¢‘ - ä½¿ç”¨æ–°çš„APIæµç¨‹
  private async parseVideoFromParams(params: Record<string, Object>, isAsync: boolean = false) {
    if (!isAsync) {
      this.isLoading = true;
    }
    
    try {
      const bvidflag = params["bvidflag"] as string;
      console.info('æ¥æ”¶åˆ°bvidflagå‚æ•°:', bvidflag);
      
      if (bvidflag) {
        const blibliurl = `https://www.bilibili.com/video/${bvidflag}`;
        console.info('å¼€å§‹å¤„ç†è§†é¢‘:', blibliurl);
        
        // æ£€æŸ¥contextå’ŒtokençŠ¶æ€
        console.info('å‡†å¤‡è·å–token...');
        if (!this.context) {
          console.error('åº”ç”¨ä¸Šä¸‹æ–‡ä¸å­˜åœ¨ï¼Œæ— æ³•è·å–token');
          promptAction.showToast({ message: 'åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œä»…å¯è§‚çœ‹æœ¬åœ°è§†é¢‘' });
          return;
        }
        
        let token: string | null = null;
        try {
          console.info('è·å–tokenä¸­...');
          // æ·»åŠ è¶…æ—¶ä¿æŠ¤
          const tokenPromise = tokenManager.getToken(this.context);
          const timeoutPromise = new Promise<null>((_, reject) => {
            setTimeout(() => reject(new Error('è·å–tokenè¶…æ—¶')), 5000);
          });
          
          token = await Promise.race([tokenPromise, timeoutPromise]);
          console.info('tokenè·å–å®Œæˆï¼ŒçŠ¶æ€:', token ? 'å·²ç™»å½•' : 'æœªç™»å½•');
        } catch (tokenError) {
          console.error('è·å–tokenæ—¶å‡ºé”™:', tokenError);
          console.error('tokené”™è¯¯è¯¦æƒ…:', JSON.stringify(tokenError));
          promptAction.showToast({ message: 'è·å–ç™»å½•çŠ¶æ€å¤±è´¥ï¼Œæœ¬åœ°è§†é¢‘ä»å¯è§‚çœ‹' });
          return;
        }
        
        if (!token) {
          console.error('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•å¤„ç†è§†é¢‘');
          try {
            promptAction.showToast({ message: 'è¯·å…ˆç™»å½•åå†è§£æåœ¨çº¿è§†é¢‘ï¼Œæœ¬åœ°è§†é¢‘ä»å¯è§‚çœ‹' });
          } catch (toastError) {
            console.error('æ˜¾ç¤ºtoastæ—¶å‡ºé”™:', toastError);
          }
          return;
        }
        
        console.info('å¼€å§‹è°ƒç”¨æ–°çš„è§†é¢‘å¤„ç†æµç¨‹...');
        console.info('è°ƒç”¨å‚æ•° - context:', this.context ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
        console.info('è°ƒç”¨å‚æ•° - url:', blibliurl);
        
        let result: BilibiliVideoInfo | null = null;
        try {
          console.info('å‡†å¤‡è°ƒç”¨processVideoComplete...');
          // ä½¿ç”¨æ–°çš„å®Œæ•´è§†é¢‘å¤„ç†æµç¨‹ï¼Œæ·»åŠ è¶…æ—¶ä¿æŠ¤
          const apiPromise = bilibiliService.processVideoComplete(this.context, blibliurl);
          const timeoutPromise = new Promise<null>((_, reject) => {
            setTimeout(() => reject(new Error('è§†é¢‘å¤„ç†è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')), 900000); // 15åˆ†é’Ÿè¶…æ—¶ï¼Œé€‚åº”ffmpegè¾ƒé•¿çš„å¤„ç†æ—¶é—´
          });
          
          console.info('å¼€å§‹ç­‰å¾…APIå“åº”...');
          result = await Promise.race([apiPromise, timeoutPromise]);
          console.info('è§†é¢‘å¤„ç†æµç¨‹ç»“æœ:', result ? 'æˆåŠŸ' : 'å¤±è´¥');
          console.info('APIè°ƒç”¨å®Œæˆï¼Œå‡†å¤‡å¤„ç†ç»“æœ...');
        } catch (apiError) {
          console.error('è°ƒç”¨è§†é¢‘å¤„ç†æµç¨‹æ—¶å‡ºé”™:', apiError);
          console.error('APIé”™è¯¯è¯¦æƒ…:', JSON.stringify(apiError));
          
          // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
          let errorMessage = 'è§†é¢‘è§£æå¤±è´¥ï¼Œä½†æœ¬åœ°è§†é¢‘ä»å¯è§‚çœ‹';
          if (apiError.message.includes('è¶…æ—¶')) {
            errorMessage = 'è§†é¢‘è§£æè¶…æ—¶ï¼Œæœ¬åœ°è§†é¢‘ä»å¯è§‚çœ‹ã€‚è§£æå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·ç¨åé‡è¯•';
          } else if (apiError.message.includes('401')) {
            errorMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ã€‚æœ¬åœ°è§†é¢‘ä»å¯è§‚çœ‹';
          } else if (apiError.message.includes('ç½‘ç»œ')) {
            errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæœ¬åœ°è§†é¢‘ä»å¯è§‚çœ‹ã€‚è¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®åé‡è¯•';
          }
          
          promptAction.showToast({ message: errorMessage });
          // ä¸å†è°ƒç”¨loadDefaultVideos()ï¼Œå› ä¸ºå·²ç»åœ¨å¼€å§‹æ—¶åŠ è½½äº†
          return;
        }
        
        if (result) {
          console.info('è§†é¢‘å¤„ç†æˆåŠŸï¼Œä¿¡æ¯:', {
            title: result.title,
            bvid: result.bvid,
            videoUrl: result.videoUrl ? 'æœ‰è§†é¢‘é“¾æ¥' : 'æ— è§†é¢‘é“¾æ¥'
          });
          
          try {
            const videoData: VideoData = {
              description: result.title || 'æœªçŸ¥æ ‡é¢˜',
              head: result.pic || $r('app.media.photo35'), // ä½¿ç”¨é»˜è®¤å°é¢
              video: result.videoUrl,
              audioUrl: result.audioUrl,
              bvid: result.bvid,
              aid: String(result.aid || '0'),
              cid: String(result.cid || '0'),
              name: result.name || 'æœªçŸ¥UPä¸»',
              face: result.face || 'https://i0.hdslb.com/bfs/face/84f1e4b0dd26cc45bb268275e68747cf9e8ba334.jpg',
              view: String(result.view || '0'),
              like: String(result.like || '0'),
              barrage: String(result.danmaku || '0'),
              time: String(result.duration || '0'),
              pubdate: String(result.pubdate || '0'),
              coins: String(result.coin || '0'),
              favorites: String(result.favorite || '0'),
              shares: String(result.share || '0'),
              reply: String(result.reply || '0'),
              tname: result.tname || 'æœªçŸ¥åˆ†åŒº',
              controller: this.myController,
              auto: false,
              play: false,
              index: '0',
              total: String(result.view || '0')
            };
            
            if (isAsync) {
              // å¼‚æ­¥æ¨¡å¼ï¼šå°†è§£ææˆåŠŸçš„è§†é¢‘æ’å…¥åˆ°å½“å‰æ’­æ”¾è§†é¢‘çš„ä¸‹ä¸€ä¸ªä½ç½®
              const currentIndex = this.index;
              const insertIndex = currentIndex + 1;
              this.datas.addData(insertIndex, videoData);
              console.info(`è§£æçš„è§†é¢‘å·²æ’å…¥åˆ°ç¬¬${insertIndex}ä½ï¼Œä½œä¸ºä¸‹ä¸€ä¸ªæ’­æ”¾è§†é¢‘`);
              
              // æ˜¾ç¤ºè§£ææˆåŠŸçš„æç¤º
              promptAction.showToast({ message: 'ç›®æ ‡è§†é¢‘è§£æå®Œæˆï¼å·²æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨' });
            } else {
              // åŒæ­¥æ¨¡å¼ï¼šå°†è§£ææˆåŠŸçš„è§†é¢‘æ’å…¥åˆ°åˆ—è¡¨å¼€å¤´ï¼Œè®©ç”¨æˆ·ä¼˜å…ˆçœ‹åˆ°è§£æçš„å†…å®¹
              this.datas.addData(0, videoData);
              console.info('è§£æçš„è§†é¢‘å·²æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´ï¼Œç”¨æˆ·å¯ä»¥æ— ç¼åˆ‡æ¢');
              
              // æ˜¾ç¤ºè§£ææˆåŠŸçš„æç¤º
              promptAction.showToast({ message: 'è§†é¢‘è§£ææˆåŠŸï¼' });
            }
          } catch (dataError) {
            console.error('åˆ›å»ºè§†é¢‘æ•°æ®æ—¶å‡ºé”™:', dataError);
            console.error('æ•°æ®é”™è¯¯è¯¦æƒ…:', JSON.stringify(dataError));
            promptAction.showToast({ message: 'è§†é¢‘æ•°æ®å¤„ç†å¤±è´¥ï¼Œä½†æœ¬åœ°è§†é¢‘ä»å¯è§‚çœ‹' });
          }
        } else {
          console.error('è§†é¢‘å¤„ç†å¤±è´¥ï¼šAPIè¿”å›ç©ºç»“æœ');
          promptAction.showToast({ message: 'è§†é¢‘è§£æå¤±è´¥ï¼Œä½†æœ¬åœ°è§†é¢‘ä»å¯è§‚çœ‹' });
        }
      } else {
        console.error('æœªæ¥æ”¶åˆ°æœ‰æ•ˆçš„bvidflagå‚æ•°');
        this.loadDefaultVideos();
      }
    } catch (error) {
      console.error('å¤„ç†è§†é¢‘æ—¶å‡ºç°æœªæ•è·çš„é”™è¯¯:', error);
      console.error('æœªæ•è·é”™è¯¯è¯¦æƒ…:', JSON.stringify(error));
      console.error('é”™è¯¯å †æ ˆ:', error.stack);
      this.loadDefaultVideos();
    } finally {
      if (!isAsync) {
        this.isLoading = false;
      }
      console.info('parseVideoFromParamsæ–¹æ³•æ‰§è¡Œå®Œæˆ');
    }
  }

  // æ­¤å¤„å·²åˆ é™¤é‡å¤çš„handleFallbackModeæ–¹æ³•ï¼Œä½¿ç”¨ä¸Šé¢çš„å®ç°
  
  // åŠ è½½é»˜è®¤è§†é¢‘ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
  private loadDefaultVideos() {
    console.info('åŠ è½½é»˜è®¤è§†é¢‘ï¼ˆå·²é‡å®šå‘åˆ°å†å²è§†é¢‘ï¼‰');
    this.loadHistoryVideosAsBackup();
  }

  // åŠ è½½å†å²è§†é¢‘ä½œä¸ºå¤‡é€‰å†…å®¹
  private async loadHistoryVideosAsBackup() {
    try {
      console.info('å¼€å§‹åŠ è½½ç”¨æˆ·å†å²è§†é¢‘ä½œä¸ºå¤‡é€‰å†…å®¹...');
      
      // æ¸…ç©ºç°æœ‰æ•°æ®
      this.datas.clearData();
      
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      if (!this.context) {
        console.warn('åº”ç”¨ä¸Šä¸‹æ–‡ä¸å­˜åœ¨ï¼Œæ— æ³•åŠ è½½å†å²è§†é¢‘');
        return;
      }
      
      const token = await tokenManager.getToken(this.context);
      if (!token) {
        console.warn('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•åŠ è½½å†å²è§†é¢‘');
        return;
      }
      
      // è·å–ç”¨æˆ·å†å²è§†é¢‘
      const historyVideos = await apiService.getUserVideos(token);
      
      if (historyVideos && historyVideos.length > 0) {
        console.info(`æˆåŠŸè·å–${historyVideos.length}ä¸ªå†å²è§†é¢‘`);
        
        // è½¬æ¢ä¸ºVideoDataæ ¼å¼
        historyVideos.forEach((video, index) => {
          const videoData: VideoData = {
            description: video.title || 'æœªçŸ¥æ ‡é¢˜',
            head: video.pic || $r('app.media.photo35'),
            video: video.download_link || '',
            audioUrl: '',
            bvid: video.bvid,
            aid: String(video.id),
            cid: video.cid || '0',
            name: video.name,
            face: video.face || 'https://i0.hdslb.com/bfs/face/84f1e4b0dd26cc45bb268275e68747cf9e8ba334.jpg',
            view: String(video.view || '0'),
            like: String(video.like || '0'),
            barrage: String(video.danmaku || '0'),
            time: String(video.duration || '0'),
            pubdate: String(video.pubdate || '0'),
            coins: String(video.coin || '0'),
            favorites: String(video.favorite || '0'),
            shares: String(video.share || '0'),
            reply: String(video.reply || '0'),
            tname: video.tname || 'æœªçŸ¥åˆ†åŒº',
            controller: this.myController,
            auto: false,
            play: false,
            index: index.toString(),
            total: String(video.current_viewers || '0'),
            preloaded_url: '',
            preloaded_audio: ''
          };
          
          this.datas.pushData(videoData);
        });
        
        console.info('å†å²è§†é¢‘åŠ è½½å®Œæˆï¼Œç”¨æˆ·å¯ä»¥å…ˆè§‚çœ‹å†å²å†…å®¹');
        
        // é¢„åŠ è½½å‰3ä¸ªè§†é¢‘çš„æ’­æ”¾é“¾æ¥
        const videosToPreload = historyVideos.slice(0, 3).map((video): UserVideoInfo => ({
          id: video.id,
          bvid: video.bvid,
          title: video.title,
          pic: video.pic,
          duration: video.duration,
          view: video.view,
          danmaku: video.danmaku,
          like: video.like,
          coin: video.coin,
          share: video.share,
          favorite: video.favorite,
          reply: video.reply,
          owner_name: video.name,
          owner_face: video.face,
          pubdate: video.pubdate,
          tname: video.tname,
          download_link: video.download_link,
          current_viewers: video.current_viewers,
          quality: video.quality,
          aid: video.aid,
          desc: video.desc,
          name: video.name,
          face: video.face,
          cid: video.cid,
          relation_type: video.relation_type,
          relation_created_at: video.relation_created_at,
          relation_desc: video.relation_desc
        }));
        
        // å¼‚æ­¥é¢„åŠ è½½ï¼Œä¸é˜»å¡ç•Œé¢
        this.preloadVideoLinks(videosToPreload).then(() => {
          console.info('å†å²è§†é¢‘é¢„åŠ è½½å®Œæˆ');
        });
        
      } else {
        console.info('æ²¡æœ‰æ‰¾åˆ°å†å²è§†é¢‘');
      }
      
    } catch (error) {
      console.error('åŠ è½½å†å²è§†é¢‘å¤±è´¥:', error);
    }
  }
  // æ­¤å¤„åˆ é™¤é‡å¤çš„loadHistoryVideosAsBackupæ–¹æ³•å®ç°
  
  // å¼‚æ­¥è§£æç›®æ ‡è§†é¢‘ï¼ˆä¸é˜»å¡ç”¨æˆ·è§‚çœ‹å†å²è§†é¢‘ï¼‰
  private async parseVideoFromParamsAsync(params: Record<string, Object>) {
    try {
      console.info('å¼€å§‹å¼‚æ­¥è§£æç›®æ ‡è§†é¢‘...');
      
      // æ˜¾ç¤ºè§£ææç¤º
      promptAction.showToast({ message: 'æ­£åœ¨åå°è§£æç›®æ ‡è§†é¢‘ï¼Œæ‚¨å¯ä»¥å…ˆè§‚çœ‹å…¶ä»–è§†é¢‘' });
      
      // å¼‚æ­¥æ‰§è¡Œè§£æï¼Œä¸é˜»å¡å½“å‰ç•Œé¢
      setTimeout(async () => {
        await this.parseVideoFromParams(params, true); // ä¼ å…¥trueè¡¨ç¤ºæ˜¯å¼‚æ­¥æ¨¡å¼
      }, 100);
      
    } catch (error) {
      console.error('å¼‚æ­¥è§£æè§†é¢‘å¤±è´¥:', error);
    }
  }

  // å¤„ç†è§†é¢‘æ»‘åŠ¨äº‹ä»¶ï¼Œå®ç°åŠ¨æ€é¢„åŠ è½½å’Œé‰´æƒ
  private async handleVideoSwipe(currentIndex: number) {
    try {
      console.info(`ç”¨æˆ·æ»‘åŠ¨åˆ°ç¬¬${currentIndex}ä¸ªè§†é¢‘ï¼Œå¼€å§‹å¤„ç†è§†é¢‘åˆ‡æ¢`);
      
      // è·å–å½“å‰è§†é¢‘æ€»æ•°
      const totalVideos = this.datas.totalCount();
      console.info(`å½“å‰è§†é¢‘æ€»æ•°: ${totalVideos}`);
      
      // è·å–å½“å‰è§†é¢‘æ•°æ®
      const currentVideo = this.datas.getData(currentIndex);
      if (currentVideo) {
        // æ£€æŸ¥å½“å‰è§†é¢‘æ˜¯å¦éœ€è¦é‰´æƒè·å–æ’­æ”¾é“¾æ¥
        await this.ensureVideoPlayable(currentVideo, currentIndex);
      }
      
      // æ™ºèƒ½é¢„åŠ è½½ç›¸é‚»è§†é¢‘ä»¥å®ç°è¿ç»­æ’­æ”¾
      console.info('å¼€å§‹æ™ºèƒ½é¢„åŠ è½½ç›¸é‚»è§†é¢‘ä»¥å®ç°è¿ç»­æ’­æ”¾');
      await this.smartPreloadAdjacentVideos(currentIndex);
      
      // é¢„åŠ è½½ç­–ç•¥ï¼šå½“ç”¨æˆ·æ»‘åŠ¨åˆ°å€’æ•°ç¬¬3ä¸ªè§†é¢‘æ—¶ï¼Œå¼€å§‹é¢„åŠ è½½æ›´å¤šè§†é¢‘
      if (currentIndex >= totalVideos - 3) {
        console.info('è§¦å‘é¢„åŠ è½½æ¡ä»¶ï¼Œå¼€å§‹åŠ è½½æ›´å¤šè§†é¢‘');
        await this.loadMoreVideosWithAuth();
      }
      
      // æ›´æ–°å½“å‰è§‚çœ‹äººæ•°ï¼ˆæ¨¡æ‹Ÿå®æ—¶æ•°æ®ï¼‰
      this.updateCurrentViewers(currentIndex);
      
    } catch (error) {
      console.error('å¤„ç†è§†é¢‘æ»‘åŠ¨äº‹ä»¶å¤±è´¥:', error);
    }
  }

  // åŠ è½½æ›´å¤šè§†é¢‘å¹¶è¿›è¡Œé‰´æƒé¢„åŠ è½½
  private async loadMoreVideosWithAuth() {
    try {
      if (this.isLoading) {
        console.info('æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
        return;
      }
      
      this.isLoading = true;
      console.info('å¼€å§‹åŠ è½½æ›´å¤šè§†é¢‘...');
      
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      if (!this.context) {
        console.error('åº”ç”¨ä¸Šä¸‹æ–‡ä¸å­˜åœ¨');
        return;
      }
      
      const token = await tokenManager.getToken(this.context);
      if (!token) {
        console.error('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•åŠ è½½æ›´å¤šåœ¨çº¿è§†é¢‘');
        return;
      }
      
      // è°ƒç”¨APIè·å–æ›´å¤šè§†é¢‘
      const moreVideos = await apiService.getUserVideos(token);
      
      if (moreVideos && moreVideos.length > 0) {
        console.info(`è·å–åˆ°${moreVideos.length}ä¸ªæ–°è§†é¢‘`);
        
        // ä¸ºè§†é¢‘æ•°æ®æ·»åŠ ç¼ºå¤±çš„å±æ€§ä»¥åŒ¹é…UserVideoInfoæ¥å£
        const processedVideos: UserVideoInfo[] = moreVideos.map((video): UserVideoInfo => {
          return {
            id: video.id,
            bvid: video.bvid,
            title: video.title,
            pic: video.pic,
            duration: video.duration,
            view: video.view,
            danmaku: video.danmaku,
            like: video.like,
            coin: video.coin,
            share: video.share,
            favorite: video.favorite,
            reply: video.reply,
            owner_name: video.name,
            owner_face: video.face,
            pubdate: video.pubdate,
            tname: video.tname,
            download_link: video.download_link,
            current_viewers: video.current_viewers,
            quality: video.quality,
            aid: video.aid,
            desc: video.desc,
            name: video.name,
            face: video.face,
            cid: video.cid,
            relation_type: video.relation_type,
            relation_created_at: video.relation_created_at,
            relation_desc: video.relation_desc
          };
        });
        
        // é¢„åŠ è½½å‰5ä¸ªè§†é¢‘çš„æ’­æ”¾é“¾æ¥
        const videosToPreload = processedVideos.slice(0, 5);
        await this.preloadVideoLinks(videosToPreload);
        
        // å°†æ‰€æœ‰æ–°è§†é¢‘æ·»åŠ åˆ°åˆ—è¡¨
        for (const videoInfo of processedVideos) {
          const videoData: VideoData = {
            description: videoInfo.title,
            head: videoInfo.pic || $r('app.media.photo35'),
            video: videoInfo.preloaded_url || videoInfo.download_link || '',
            audioUrl: videoInfo.preloaded_audio || '',
            bvid: videoInfo.bvid,
            aid: String(videoInfo.id),
            cid: '0',
            name: videoInfo.name,
            face: videoInfo.face || 'https://i0.hdslb.com/bfs/face/84f1e4b0dd26cc45bb268275e68747cf9e8ba334.jpg',
            view: String(videoInfo.view),
            like: String(videoInfo.like),
            barrage: String(videoInfo.danmaku),
            time: String(videoInfo.duration),
            pubdate: String(videoInfo.pubdate),
            coins: String(videoInfo.coin),
            favorites: String(videoInfo.favorite),
            shares: String(videoInfo.share),
            reply: String(videoInfo.reply),
            tname: videoInfo.tname,
            controller: this.myController,
            auto: false,
            play: false,
            index: this.datas.totalCount().toString(),
            total: String(videoInfo.current_viewers)
          };
          
          // å°†é¢„åŠ è½½ä¿¡æ¯å­˜å‚¨åˆ°videoDataä¸­ï¼Œä¾›åç»­ä½¿ç”¨
          videoData.preloaded_url = videoInfo.preloaded_url;
          videoData.preloaded_audio = videoInfo.preloaded_audio;
          
          this.datas.pushData(videoData);
        }
        
        console.info('æ–°è§†é¢‘å·²æ·»åŠ åˆ°åˆ—è¡¨ï¼Œé¢„åŠ è½½å®Œæˆ');
        
        // ç¡®ä¿ç¬¬ä¸€ä¸ªè§†é¢‘å¯ä»¥æ’­æ”¾
        if (this.datas.totalCount() > 0) {
          const firstVideo = this.datas.getData(0);
          await this.ensureVideoPlayable(firstVideo, 0);
        }
      }
      
    } catch (error) {
      console.error('åŠ è½½æ›´å¤šè§†é¢‘å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // é¢„åŠ è½½è§†é¢‘æ’­æ”¾é“¾æ¥
  private async preloadVideoLinks(videos: UserVideoInfo[]) {
    try {
      console.info(`å¼€å§‹é¢„åŠ è½½${videos.length}ä¸ªè§†é¢‘çš„æ’­æ”¾é“¾æ¥`);
      
      const preloadPromises = videos.map(async (video: UserVideoInfo, index: number) => {
        try {
          if (video.bvid) {
            const videoUrl = `https://www.bilibili.com/video/${video.bvid}`;
            const token = await tokenManager.getToken(this.context!);
            if (!token) {
              console.error('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•é¢„åŠ è½½è§†é¢‘');
              return;
            }
            const result = await apiService.parseVideo(token, videoUrl);
            if (result && result.play_info) {
               console.info(`è§†é¢‘${index + 1}é¢„åŠ è½½æˆåŠŸ: ${video.bvid}`);
               // å°†é¢„åŠ è½½çš„é“¾æ¥å­˜å‚¨èµ·æ¥ï¼Œä¾›åç»­ä½¿ç”¨
               video.preloaded_url = result.play_info?.video_url || '';
               video.preloaded_audio = result.play_info?.audio_url || '';
             }
          }
        } catch (error) {
          console.error(`é¢„åŠ è½½è§†é¢‘${index + 1}å¤±è´¥:`, error);
        }
      });
      
      // å¹¶å‘é¢„åŠ è½½ï¼Œä½†ä¸ç­‰å¾…å…¨éƒ¨å®Œæˆ
      Promise.allSettled(preloadPromises).then(() => {
        console.info('è§†é¢‘é¢„åŠ è½½æ‰¹æ¬¡å®Œæˆ');
      });
      
    } catch (error) {
      console.error('é¢„åŠ è½½è§†é¢‘é“¾æ¥å¤±è´¥:', error);
    }
  }

  // æ™ºèƒ½é¢„åŠ è½½ç›¸é‚»è§†é¢‘ä»¥å®ç°è¿ç»­æ’­æ”¾
  private async smartPreloadAdjacentVideos(currentIndex: number) {
    try {
      console.info(`å¼€å§‹æ™ºèƒ½é¢„åŠ è½½ï¼Œå½“å‰ç´¢å¼•: ${currentIndex}`);
      
      const totalCount = this.datas.totalCount();
      const preloadTasks: Promise<void>[] = [];
      
      // é¢„åŠ è½½ç­–ç•¥ï¼šå½“å‰è§†é¢‘çš„å‰1ä¸ªå’Œå2ä¸ªè§†é¢‘
      const preloadIndices: number[] = [];
      
      // å‰ä¸€ä¸ªè§†é¢‘
      if (currentIndex > 0) {
        preloadIndices.push(currentIndex - 1);
      }
      
      // åé¢çš„è§†é¢‘ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰
      for (let i = 1; i <= 2 && currentIndex + i < totalCount; i++) {
        preloadIndices.push(currentIndex + i);
      }
      
      console.info(`è®¡åˆ’é¢„åŠ è½½è§†é¢‘ç´¢å¼•: [${preloadIndices.join(', ')}]`);
      
      // å¹¶å‘é¢„åŠ è½½
      for (const index of preloadIndices) {
        const video = this.datas.getData(index);
        if (video && video.bvid && !this.preloadedVideos.has(video.bvid)) {
          preloadTasks.push(this.preloadSingleVideoAsync(video, index));
        }
      }
      
      // ç­‰å¾…æ‰€æœ‰é¢„åŠ è½½ä»»åŠ¡å®Œæˆï¼ˆä½†ä¸é˜»å¡ä¸»æµç¨‹ï¼‰
      if (preloadTasks.length > 0) {
        Promise.allSettled(preloadTasks).then(results => {
          const successCount = results.filter(r => r.status === 'fulfilled').length;
          console.info(`é¢„åŠ è½½å®Œæˆ: ${successCount}/${results.length} ä¸ªè§†é¢‘é¢„åŠ è½½æˆåŠŸ`);
        });
      }
      
    } catch (error) {
      console.error('æ™ºèƒ½é¢„åŠ è½½å¤±è´¥:', error);
    }
  }
  
  // è·å–æ­£ç¡®çš„è§†é¢‘æº
  private getVideoSource(item: VideoData): Resource | string {
    // ä¼˜å…ˆä½¿ç”¨é¢„åŠ è½½çš„URLï¼ˆé€šå¸¸æ˜¯æœ€æ–°çš„æœ‰æ•ˆé“¾æ¥ï¼‰
    if (item.preloaded_url && typeof item.preloaded_url === 'string' && item.preloaded_url.startsWith('http')) {
      console.info(`ğŸ¬ ä½¿ç”¨é¢„åŠ è½½è§†é¢‘æº: ${item.preloaded_url}`);
      return item.preloaded_url;
    }
    
    // å¦‚æœvideoæ˜¯HTTP URLå­—ç¬¦ä¸²ï¼Œä½¿ç”¨å®ƒ
    if (typeof item.video === 'string' && item.video.startsWith('http')) {
      console.info(`ğŸ¬ ä½¿ç”¨HTTPè§†é¢‘æº: ${item.video}`);
      return item.video;
    }
    
    // å¦‚æœéƒ½ä¸æ˜¯æœ‰æ•ˆçš„HTTPé“¾æ¥ï¼Œè®°å½•è­¦å‘Šå¹¶è¿”å›åŸå§‹å€¼
    console.warn(`âš ï¸ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„HTTPè§†é¢‘æºï¼Œä½¿ç”¨åŸå§‹æº:`, item.video);
    console.warn(`ğŸ“‹ è§†é¢‘æºè¯¦æƒ… - video: ${item.video}, preloaded_url: ${item.preloaded_url}`);
    return item.video;
  }

  // é‡è¯•è§†é¢‘æ’­æ”¾çš„æ–¹æ³•
  private async retryVideoPlayback(item: VideoData, index: number): Promise<void> {
    try {
      console.info(`ğŸ”„ å¼€å§‹é‡è¯•è§†é¢‘æ’­æ”¾: ${item.bvid}`);
      
      // ç¡®ä¿æœ‰ç”¨æˆ·token
      if (!this.userToken) {
        console.error(`âŒ é‡è¯•å¤±è´¥ï¼šç¼ºå°‘ç”¨æˆ·token`);
        return;
      }
      
      // é‡æ–°è·å–æ’­æ”¾é“¾æ¥
      const fileName = `${item.bvid}.mp4`;
      const response = await apiService.generateDownloadLink(this.userToken, fileName);
      
      if (response && response.downloadUrl) {
        console.info(`âœ… é‡è¯•è·å–æ’­æ”¾é“¾æ¥æˆåŠŸ: ${response.downloadUrl}`);
        
        // æ›´æ–°è§†é¢‘æ•°æ®
        item.video = response.downloadUrl;
        item.preloaded_url = response.downloadUrl;
        
        // å¼ºåˆ¶åˆ·æ–°Videoç»„ä»¶
        this.datas.notifyDataChange(index);
        
        console.info(`ğŸ”„ å·²æ›´æ–°è§†é¢‘ ${item.bvid} çš„æ’­æ”¾é“¾æ¥ï¼Œç­‰å¾…é‡æ–°åŠ è½½`);
      } else {
        console.error(`âŒ é‡è¯•è·å–æ’­æ”¾é“¾æ¥å¤±è´¥ï¼ŒAPIå“åº”å¼‚å¸¸:`, response);
      }
    } catch (error) {
      console.error(`âŒ é‡è¯•è§†é¢‘æ’­æ”¾å¤±è´¥:`, error);
    }
  }

  // å¼‚æ­¥é¢„åŠ è½½å•ä¸ªè§†é¢‘ - ä½¿ç”¨æ­£ç¡®çš„ä¸‹è½½é“¾æ¥API
  private async preloadSingleVideoAsync(video: VideoData, index: number): Promise<void> {
    try {
      if (!video.bvid || this.preloadedVideos.has(video.bvid)) {
        return;
      }
      
      console.info(`å¼€å§‹é¢„åŠ è½½è§†é¢‘: ${video.bvid}`);
      this.preloadedVideos.add(video.bvid);
      
      // è·å–tokenï¼ˆä¼˜å…ˆä½¿ç”¨ä¼ é€’çš„tokenï¼‰
      let token = this.userToken;
      if (!token && this.context) {
        token = await tokenManager.getToken(this.context);
      }
      
      if (!token) {
        console.warn(`é¢„åŠ è½½è§†é¢‘${video.bvid}å¤±è´¥: æ— æœ‰æ•ˆtoken`);
        return;
      }
      
      // ä½¿ç”¨generate-download-link APIè·å–çœŸæ­£å¯æ’­æ”¾çš„é“¾æ¥
      const fileName = `${video.bvid}.mp4`;
      const result = await apiService.generateDownloadLink(token, fileName);
      
      if (result && result.downloadUrl) {
        // å­˜å‚¨é¢„åŠ è½½çš„æ’­æ”¾é“¾æ¥
        video.preloaded_url = result.downloadUrl;
        video.video = result.downloadUrl; // ç›´æ¥æ›´æ–°videoå­—æ®µ
        
        // æ›´æ–°æ•°æ®æº
        this.datas.updateDataAtIndex(index, video);
        console.info(`è§†é¢‘${video.bvid}é¢„åŠ è½½æˆåŠŸï¼Œæ’­æ”¾é“¾æ¥: ${result.downloadUrl}`);
        console.info(`ğŸ”‘ ä¸‹è½½token: ${result.token}`);
        console.info(`â° é“¾æ¥è¿‡æœŸæ—¶é—´: ${result.expiresAt}`);
      } else {
        console.warn(`é¢„åŠ è½½è§†é¢‘${video.bvid}å¤±è´¥: APIè¿”å›æ— æ•ˆç»“æœ`);
        console.warn(`ğŸ“‹ APIå“åº”:`, result);
      }
      
    } catch (error) {
      console.error(`é¢„åŠ è½½è§†é¢‘${video.bvid}æ—¶å‡ºé”™:`, error);
      // é¢„åŠ è½½å¤±è´¥æ—¶ï¼Œå°è¯•ä¿æŒåŸæœ‰é“¾æ¥
      if (video.video && typeof video.video === 'string' && !video.video.startsWith('http')) {
        console.info(`ğŸ”„ ä¿æŒåŸæœ‰ä¸‹è½½é“¾æ¥: ${video.video}`);
      }
    }
  }
  
  // ç¡®ä¿è§†é¢‘å¯æ’­æ”¾ï¼ˆåŠ¨æ€é‰´æƒï¼‰
  private async ensureVideoPlayable(video: VideoData, index: number) {
    try {
      console.info(`ğŸ” æ£€æŸ¥è§†é¢‘${index}(${video.bvid})çš„æ’­æ”¾çŠ¶æ€`);
      
      // æ£€æŸ¥æ˜¯å¦æœ‰é¢„åŠ è½½çš„é“¾æ¥
      if (video.preloaded_url && video.preloaded_url.startsWith('http')) {
        console.info(`âœ… ä½¿ç”¨é¢„åŠ è½½çš„æ’­æ”¾é“¾æ¥: ${video.bvid} - ${video.preloaded_url}`);
        video.video = video.preloaded_url;
        if (video.preloaded_audio) {
          video.audioUrl = video.preloaded_audio;
        }
        // æ›´æ–°æ•°æ®æº
        this.datas.updateDataAtIndex(index, video);
        return;
      }
      
      // æ£€æŸ¥è§†é¢‘æ˜¯å¦å·²ç»æœ‰æœ‰æ•ˆçš„æ’­æ”¾é“¾æ¥ï¼ˆä¸æ˜¯download_linkï¼‰
      if (video.video && typeof video.video === 'string' && video.video.startsWith('http') && 
          !video.video.includes('/api/video/download/') && 
          !video.video.includes('download_link')) {
        console.info(`âœ… è§†é¢‘${index}å·²æœ‰æœ‰æ•ˆæ’­æ”¾é“¾æ¥ï¼Œæ— éœ€é‡æ–°è·å–: ${video.video}`);
        return;
      }
      
      // å¦‚æœæ²¡æœ‰æœ‰æ•ˆæ’­æ”¾é“¾æ¥ï¼ŒåŠ¨æ€è·å–
      if (video.bvid && this.context) {
        console.info(`ğŸ”„ å¼€å§‹ä¸ºè§†é¢‘${video.bvid}è·å–æ’­æ”¾é“¾æ¥`);
        
        // ä¼˜å…ˆä½¿ç”¨ä¼ é€’çš„token
        let token = this.userToken;
        if (!token) {
          token = await tokenManager.getToken(this.context);
        }
        
        if (!token) {
          console.error('âŒ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•è·å–æ’­æ”¾é“¾æ¥');
          return;
        }
        
        // ä½¿ç”¨generate-download-link APIè·å–çœŸæ­£å¯æ’­æ”¾çš„é“¾æ¥
        const fileName = `${video.bvid}.mp4`;
        const result = await apiService.generateDownloadLink(token, fileName);
        
        if (result && result.downloadUrl) {
          // å°†è·å–åˆ°çš„æ’­æ”¾é“¾æ¥å­˜å‚¨åˆ°è§†é¢‘æ•°æ®ä¸­
          video.video = result.downloadUrl;
          video.preloaded_url = result.downloadUrl;
          
          // æ›´æ–°æ•°æ®æº
          this.datas.updateDataAtIndex(index, video);
          console.info(`âœ… è§†é¢‘${video.bvid}æ’­æ”¾é“¾æ¥è·å–æˆåŠŸ: ${result.downloadUrl}`);
          console.info(`ğŸ”‘ ä¸‹è½½token: ${result.token}`);
          console.info(`â° é“¾æ¥è¿‡æœŸæ—¶é—´: ${result.expiresAt}`);
          console.info(`ğŸ¬ è§†é¢‘æºç±»å‹: ${typeof result.downloadUrl}`);
          console.info(`ğŸ”— é“¾æ¥é•¿åº¦: ${result.downloadUrl.length}`);
        } else {
          console.warn(`âŒ è·å–è§†é¢‘${video.bvid}æ’­æ”¾é“¾æ¥å¤±è´¥`);
          console.warn(`ğŸ“‹ APIå“åº”:`, JSON.stringify(result));
          
          // å¦‚æœè·å–å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åŸæœ‰çš„ä¸‹è½½é“¾æ¥
          if (video.video && typeof video.video === 'string' && !video.video.startsWith('http')) {
            console.info(`ğŸ”„ ä½¿ç”¨åŸæœ‰ä¸‹è½½é“¾æ¥: ${video.video}`);
          }
        }
      }
    } catch (error) {
      console.error(`âŒ ç¡®ä¿è§†é¢‘${video.bvid}å¯æ’­æ”¾æ—¶å‡ºé”™:`, JSON.stringify(error));
      console.error(`ğŸ” é”™è¯¯è¯¦æƒ…:`, error);
    }
  }
  
  // æ›´æ–°å½“å‰è§‚çœ‹äººæ•°
  private updateCurrentViewers(index: number) {
    try {
      const currentVideo = this.datas.getData(index);
      if (currentVideo && currentVideo.total) {
        this.totalindex = (parseInt(currentVideo.total) || 0).toString();
      }
    } catch (error) {
      console.error('æ›´æ–°è§‚çœ‹äººæ•°å¤±è´¥:', error);
    }
  }
  onPageShow(): void {
    const currentData = this.datas.getData(this.index);
    if (currentData && currentData.controller && typeof currentData.controller.start === 'function') {
      currentData.controller.start();
    }
  }
  onPageHide(): void {
    const currentData = this.datas.getData(this.index);
    if (currentData && currentData.controller && typeof currentData.controller.pause === 'function') {
      currentData.controller.pause();
    }
  }

  build() {
    Stack({ alignContent: Alignment.Top }) {
      Column() {
        Swiper(this.swiperController) {
          LazyForEach(this.datas, (item: VideoData, index: number) => {
            Stack({ alignContent: Alignment.Center }) {
              Stack({ alignContent: Alignment.BottomStart }) {
                Stack({ alignContent: Alignment.BottomEnd }) {
                  Video({
                    src: this.getVideoSource(item),
                    controller: item.controller,
                    previewUri: item.head,
                  })
                    .width(Const.FULL_SIZE)
                    .height(Const.FULL_SIZE)
                    .objectFit(ImageFit.Contain)
                    .loop(true)
                    .autoPlay(item.auto)
                    .controls(true) // å¯ç”¨æ§åˆ¶æ¡ä»¥ä¾¿è°ƒè¯•
                    .muted(false) // ç¡®ä¿éŸ³é¢‘æœªé™éŸ³
                    .opacity(1.0) // ç¡®ä¿è§†é¢‘å¯è§
                    .backgroundColor(Color.Black) // è®¾ç½®èƒŒæ™¯è‰²
                    .onPrepared((err) => {
                      if (err) {
                        console.error(`âŒ è§†é¢‘å‡†å¤‡å¤±è´¥ ${item.bvid}:`, JSON.stringify(err));
                        console.error(`ğŸ“¹ è§†é¢‘æº:`, this.getVideoSource(item));
                        console.error(`ğŸ” è§†é¢‘æºç±»å‹:`, typeof this.getVideoSource(item));
                        console.error(`ğŸ“‹ å®Œæ•´è§†é¢‘æ•°æ®:`, JSON.stringify(item));
                      } else {
                        console.info(`âœ… è§†é¢‘å‡†å¤‡æˆåŠŸ ${item.bvid}`);
                        console.info(`ğŸ¬ æˆåŠŸåŠ è½½è§†é¢‘æº:`, this.getVideoSource(item));
                        // å»¶è¿Ÿå¯åŠ¨æ’­æ”¾ï¼Œç¡®ä¿è§†é¢‘å®Œå…¨å‡†å¤‡å¥½
                        setTimeout(() => {
                          if (item && item.controller && typeof item.controller.start === 'function') {
                            item.controller.start();
                            console.info(`â–¶ï¸ å¼€å§‹æ’­æ”¾è§†é¢‘ ${item.bvid}`);
                          }
                        }, 100);
                      }
                    })
                    .onError(() => {
                      console.error(`âŒ è§†é¢‘æ’­æ”¾é”™è¯¯ ${item.bvid}`);
                      console.error(`ğŸ“¹ å½“å‰è§†é¢‘æº:`, this.getVideoSource(item));
                      console.error(`ğŸ” è§†é¢‘æºç±»å‹:`, typeof this.getVideoSource(item));
                      console.error(`ğŸ“‹ è§†é¢‘æ•°æ®:`, JSON.stringify({
                        bvid: item.bvid,
                        video: item.video,
                        preloaded_url: item.preloaded_url,
                        head: item.head,
                        description: item.description
                      }));
                      
                      // å°è¯•é‡æ–°è·å–æ’­æ”¾é“¾æ¥
                      console.warn(`ğŸ”„ å°è¯•é‡æ–°è·å–è§†é¢‘ ${item.bvid} çš„æ’­æ”¾é“¾æ¥`);
                      this.retryVideoPlayback(item, index);
                    })
                    .onStart(() => {
                      item.play = true;
                      const currentData = this.datas.getData(this.index);
                      if (currentData) {
                        this.playBoo = currentData.play;
                      }
                    })
                    .onPause(() => {
                      item.play = false;
                      const currentData = this.datas.getData(this.index);
                      if (currentData) {
                        this.playBoo = currentData.play;
                      }
                    })
                    .onClick(() => {
                      if (item && item.controller) {
                        if (item.play && typeof item.controller.pause === 'function') {
                          item.controller.pause();
                        } else if (!item.play && typeof item.controller.start === 'function') {
                          item.controller.start();
                        }
                      }
                    })
                    .onVisibleAreaChange([0.0, 1.0], (isVisisble: boolean, currentRatio: number) => {
                      if (isVisisble && currentRatio >= 1.0 && item && item.controller && typeof item.controller.start === 'function') {
                        item.controller.start();
                        this.totalindex = String(item.total || '0');
                      }
                    })
                  Side({
                    likeCount: String(item.like), // ç‚¹èµæ•°,ç‹¬ç‰¹ç‰¹æ€§ï¼ˆbugï¼ï¼‰
                    commentCount: String(item.barrage), // è¯„è®ºæ•° ç›®å‰æ˜¯å¼¹å¹•
                    favoriteCount: String(item.favorites), // æ”¶è—æ•°
                    shareCount: String(item.shares), // åˆ†äº«æ•°
                    toubiCount: String(item.coins),

                    index: Number(item.index) // ç´¢å¼•
                  })
                }.width(Const.FULL_SIZE).height(Const.FULL_SIZE).padding($r('app.integer.stack_padding'))

                VideoDes({
                  head: item.face,
                  name: item.name,
                  description: item.description,
                  hotspot: String(item.pubdate),
                  time: String(item.time),
                  viewCount: String(item.view),
                })
                  .margin({ bottom: $r('app.integer.video_des_margin_bottom') })
                // Row() {
                //   Row() {
                //     Image($r('app.media.ic_public_upgrade_filled'))
                //       .height($r('app.integer.upgrade_icon_size'))
                //       .width($r('app.integer.upgrade_icon_size'))
                //     Text($r('app.string.upgrade_hot'))
                //       .fontSize($r('app.integer.upgrade_text_font_size'))
                //       .fontColor($r('app.color.up_color'))
                //     Text(' Â· ' + '2024å¹´11æœˆ5æ—¥17ç‚¹17åˆ†')
                //       .fontSize($r('app.integer.mus_font_size'))
                //       .maxLines(1)
                //       .width('2024å¹´11æœˆ5æ—¥17ç‚¹17åˆ†'.length * 12)
                //       .fontColor(Color.White)
                //       .height($r('app.integer.mus_height'))
                //       .textOverflow({ overflow: TextOverflow.Ellipsis })
                //       .layoutWeight(1)
                //   }
                //   .width(Const.ROW_WIDTH)
                //
                //   Row() {
                //     Divider()
                //       .vertical(true)
                //       .color(Color.White)
                //       .strokeWidth(1)
                //       .height($r('app.integer.upgrade_text_font_size'))
                //       .margin({ left: $r('app.integer.upgrade_margin'), right: $r('app.integer.upgrade_margin') })
                //     Text($r('app.string.online_people'))
                //       .fontSize($r('app.integer.mus_font_size'))
                //       .fontColor(Color.White)
                //     Image($r('app.media.ic_arrow_right'))
                //       .width($r('app.integer.upgrade_text_font_size'))
                //   }
                //   .layoutWeight(1)
                //   .justifyContent(FlexAlign.End)
                // }
                // .width(Const.FULL_SIZE)
                // .height($r('app.integer.upgrade_height'))
                // .backgroundColor(Color.Gray)
                // .opacity($r('app.float.fabulous_opacity'))
                // .padding({ left: $r('app.integer.upgrade_padding'), right: $r('app.integer.upgrade_padding') })
                // .justifyContent(FlexAlign.Start)


              }.width(Const.FULL_SIZE).height(Const.FULL_SIZE).padding(0)

              if (!this.playBoo) {
                Image($r('app.media.pau'))
                  .height($r('app.integer.play_icon_size'))
                  .width($r('app.integer.play_icon_size'))
                  .onClick(() => {
                    if (item && item.controller && typeof item.controller.start === 'function') {
                      item.controller.start();
                      item.play = true;
                      this.playBoo = true;
                    }
                  })
              }
            }.width(Const.FULL_SIZE).height(Const.FULL_SIZE).padding($r('app.integer.stack_padding'))
          }, (item: VideoData) => JSON.stringify(item))
        }
        .width('100%')
        .height('100%')
        .vertical(true)
        .autoPlay(false)
        .indicator(false)
        .loop(true)
        // .duration(Const.DURATION)
        .cachedCount(0)
        .vertical(true)
        .itemSpace(0)
        .curve(curves.interpolatingSpring(-1, 1, 328, 34))
        .onChange(async (index) => {
          this.index = index;
          this.playBoo = true;
          videoIndex = index;
          
          // åŠ¨æ€é¢„åŠ è½½æœºåˆ¶ï¼šå½“ç”¨æˆ·æ»‘åŠ¨åˆ°æŸä¸ªè§†é¢‘æ—¶ï¼Œé¢„åŠ è½½åç»­è§†é¢‘
          // ä½¿ç”¨å¼‚æ­¥å¤„ç†ï¼Œé¿å…é˜»å¡UI
          this.handleVideoSwipe(index).catch((error: Error) => {
            console.error('å¤„ç†è§†é¢‘åˆ‡æ¢å¤±è´¥:', error);
          });
        })
      }
      .width('100%')
      .height('100%')


      Row() {

        RelativeContainer() {
          Image($r("app.media.chevron_left"))
            .width(25)
            .height(25)
            .onClick(() => {
              router.back();
            })
            .alignRules({
              top: { anchor: "__container__", align: VerticalAlign.Top },
              left: { anchor: "__container__", align: HorizontalAlign.Start }
            })
            .id("tuichu")

          Image($r("app.media.person_2"))
            .width(20)
            .height(25)
            .onClick(() => {
              router.back();
            })
            .alignRules({
              top: { anchor: "__container__", align: VerticalAlign.Top },
              left: { anchor: "tuichu", align: HorizontalAlign.End }
            })
            .id("person_2")

          Text(this.totalindex+'äººæ­£åœ¨çœ‹')
            .height(25)
            .fontSize($r('app.integer.fabulous_font_size'))
            .fontColor(Color.White)
            .opacity($r('app.float.fabulous_opacity'))
            .margin({left:10})
            .alignRules({
              top: { anchor: "__container__", align: VerticalAlign.Top },
              left: { anchor: "person_2", align: HorizontalAlign.End }
            })
            .id("text")
          // List({ scroller: this.scroller }) {
          //   LazyForEach(this.topTabListData, (item: string, index) => {
          //     ListItem() {
          //       Column() {
          //         Text(item)
          //           .fontColor(this.currentIndex === index ? Color.White : $r('app.color.font_color'))
          //           .fontSize($r('app.integer.tab_font_size'))
          //         Divider()
          //           .width(this.currentIndex === index ? $r('app.integer.tab_divider_width') : $r('app.integer.tab_divider_width_0'))
          //           .strokeWidth(2)
          //           .color(this.currentIndex === index ? Color.White : Color.Gray)
          //           .margin({
          //             top: $r('app.integer.divider_margin_top')
          //           })
          //       }
          //       .padding({ top: $r('app.integer.tab_padding_top') })
          //       .width(Const.LIST_ITEM_WIDTH)
          //     }
          //   }, (item: string, index) => JSON.stringify(item))
          // }
          // .listDirection(Axis.Horizontal)
          // .height(Const.FULL_SIZE)
          // .width(Const.LIST_WIDTH)
          Image($r("app.media.search"))
            .width($r('app.integer.search_icon_width'))
            .height($r('app.integer.search_icon_height'))
            .alignRules({
              top: { anchor: "__container__", align: VerticalAlign.Top },
              right: { anchor: "dian", align: HorizontalAlign.Start }
            })
            .id("sousuo")
          Image($r("app.media.ellypsis"))
            .width($r('app.integer.add_icon_width'))
            .height($r('app.integer.add_icon_width'))
            .alignRules({
              top: { anchor: "__container__", align: VerticalAlign.Top },
              right: { anchor: "__container__", align: HorizontalAlign.End }
            })
            .id("dian")
        }
      }
      .margin({top:10})
      .height($r('app.integer.tab_list_height'))
      .width(Const.FULL_SIZE)
      .alignItems(VerticalAlign.Center)
      // .justifyContent(FlexAlign.SpaceAround)
    }


  }
}

