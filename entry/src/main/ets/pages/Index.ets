/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { router } from '@kit.ArkUI';
import { CommonConstants as Const } from '../common/constants/CommonConstants';
import { splashImages } from '../viewmodel/SplashModel';
// å¯¼å…¥TokenManager
import { tokenManager } from '../utils/TokenManager';
// ã€æ–°å¢žã€‘å¯¼å…¥ AbilityKit çš„ common æ¨¡å—
import { common } from '@kit.AbilityKit';
// ã€æ–°å¢žã€‘å¯¼å…¥ApiServiceç”¨äºŽçŠ¶æ€æ£€æµ‹
import { apiService } from '../api/ApiService';
@Entry
@Component
struct Index {
  private swiperController: SwiperController = new SwiperController();
  private data: Resource[] = [];
  @State countdown: number = Const.COUNTDOWN;
  @State showSwiper: boolean = false;
  private timer: number = 0;

  // aboutToAppear ä¿æŒä¸å˜
  aboutToAppear(): void {
    let data: Resource[] = [];
    let hours = new Date().getHours();
    if (hours >= Const.MORNING_TIME && hours < Const.EVENING_TIME) {
      data = splashImages.day;
    } else if (hours >= Const.EVENING_TIME && hours <= Const.NIGHT_TIME) {
      data = splashImages.dusk;
    } else {
      data = splashImages.night;
    }
    this.data = data;
    setTimeout(() => {
      this.showSwiper = true;
      this.startTiming();
    }, Const.SPLASH_DURATION);
  }

  startTiming() {
    this.timer = setInterval(() => {
      this.countdown--;
      if (this.countdown === 0) {
        this.clearTiming();
        // è°ƒç”¨æ–°çš„å¯¼èˆªå†³ç­–å‡½æ•°
        this.decideAndNavigate();
      }
    }, Const.DURATION);
  }

  clearTiming() {
    if (this.timer !== null && this.timer !== 0) { // æ£€æŸ¥æ¡ä»¶æ›´ä¸¥è°¨
      clearInterval(this.timer);
      this.timer = 0;
    }
  }

  // ã€æ ¸å¿ƒä¿®æ”¹ã€‘
  // åŽŸ jumpToMainPage() å‡½æ•°è¢«æ›¿æ¢ä¸º decideAndNavigate()
  async decideAndNavigate() {
    this.clearTiming();
    // èŽ·å–UIAbilityçš„ä¸Šä¸‹æ–‡ï¼Œç”¨äºŽè¯»å†™Preferences
    const context = AppStorage.get('uiAbilityContext') as common.UIAbilityContext;

    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨Token
    const token = await tokenManager.getToken(context);

    if (token) {
      console.info('Token found, verifying with backend...');
      
      // ã€æ–°å¢žã€‘è°ƒç”¨åŽç«¯APIéªŒè¯tokenæœ‰æ•ˆæ€§
      try {
        const statusResult = await apiService.checkStatus(token);
        
        if (statusResult.success && statusResult.data) {
          // Tokenæœ‰æ•ˆï¼Œç”¨æˆ·çŠ¶æ€æ­£å¸¸ï¼Œå°†éªŒè¯ä¿¡æ¯å­˜å‚¨åˆ°AppStorage
          console.info('TokenéªŒè¯æˆåŠŸï¼Œç”¨æˆ·çŠ¶æ€æ­£å¸¸ï¼Œè·³è½¬åˆ°ä¸»é¡µ');
          console.info(`ç”¨æˆ·ä¿¡æ¯: ${statusResult.data.name} (${statusResult.data.email})`);
          
          // ðŸ”¥ å…³é”®ä¿®å¤ï¼šå°†éªŒè¯æˆåŠŸçš„tokenå’Œç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°AppStorage
          AppStorage.setOrCreate('verifiedToken', token);
          AppStorage.setOrCreate('userInfo', statusResult.data);
          AppStorage.setOrCreate('tokenVerified', true);
          
          console.info('âœ… å·²å°†éªŒè¯æˆåŠŸçš„tokenå­˜å‚¨åˆ°AppStorage');
          
          router.replaceUrl({
            url: 'pages/MainPage'
          });
        } else {
          // Tokenæ— æ•ˆæˆ–ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ï¼Œæ¸…é™¤æœ¬åœ°tokenå¹¶è·³è½¬åˆ°ç™»å½•é¡µ
          console.warn(`TokenéªŒè¯å¤±è´¥: ${statusResult.message || 'æœªçŸ¥é”™è¯¯'}`);
          await this.handleInvalidToken(context);
        }
      } catch (error) {
        // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–å¼‚å¸¸ï¼Œæ¸…é™¤tokenå¹¶è·³è½¬ç™»å½•é¡µ
        console.error('TokenéªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
        await this.handleInvalidToken(context);
      }
    } else {
      // å¦‚æžœæ²¡æœ‰tokenï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
      console.info('No token found, navigating to LoginPage.');
      router.replaceUrl({
        url: 'pages/LoginPage'
      });
    }
  }

  // ã€æ–°å¢žã€‘å¤„ç†æ— æ•ˆtokençš„ç»Ÿä¸€æ–¹æ³•
  private async handleInvalidToken(context: common.UIAbilityContext) {
    try {
      // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„æ— æ•ˆtoken
      await tokenManager.deleteToken(context);
      console.info('å·²æ¸…é™¤æ— æ•ˆtoken');
    } catch (error) {
      console.error('æ¸…é™¤tokenæ—¶å‘ç”Ÿé”™è¯¯:', error);
    }
    
    // è·³è½¬åˆ°ç™»å½•é¡µ
    console.info('è·³è½¬åˆ°ç™»å½•é¡µ');
    router.replaceUrl({
      url: 'pages/LoginPage'
    });
  }

  aboutToDisappear() {
    this.clearTiming();
  }

  build() {
    Column() {
      Stack() {
        if (this.showSwiper) {
          Swiper(this.swiperController) {
            ForEach(this.data, (item: Resource) => {
              Image(item)
                .width(Const.FULL_SIZE)
                .height(Const.FULL_SIZE)
                .objectFit(ImageFit.Cover)
            })
          }
          .loop(true)
          .interval(2 * Const.DURATION)
          .duration(Const.DURATION)
          .autoPlay(true)
          .indicator(false)
          .curve(Curve.Linear)
          .onChange((index: number) => {
            console.info(index.toString())
          })

          Text() {
            Span($r('app.string.skip'))
            Span(`${this.countdown}`)
          }
          // ç‚¹å‡»è·³è¿‡æŒ‰é’®ï¼Œä¹Ÿæ‰§è¡Œå¯¼èˆªå†³ç­–
          .onClick(() => this.decideAndNavigate())
          .fontColor(Color.White)
          .fontSize($r('app.float.12fp'))
          .backgroundColor($r('app.color.swiper_jump_bg_color'))
          .width($r('app.float.63'))
          .height($r('app.float.24'))
          .borderRadius($r('app.float.10'))
          .textAlign(TextAlign.Center)
          .position({
            x: Const.PERCENTAGE_78,
            y: $r('app.float.35')
          })
        } else {
          Image($r('app.media.splash_bg'))
            .width('100%')
            .height('100%')
          Image($r('app.media.ic_splash'))
            .width($r('app.float.192'))
            .height($r('app.float.192'))
            .offset({
              y: `-${Const.PERCENTAGE_15}`
            })
            .objectFit(ImageFit.Contain)

          Column() {
            Text(Const.SPLASH_DES)
              .fontColor(Color.White)
              .fontSize($r('app.float.font_size_24fp'))
              .fontWeight(FontWeight.Medium)

            Text(Const.SPLASH_WELCOME)
              .fontSize($r('app.float.font_size_16fp'))
              .fontColor(Color.White)
              .margin({
                top: $r('app.float.5')
              })
          }
          .offset({
            y: Const.PERCENTAGE_25
          })
        }
      }
    }
    .height(Const.FULL_SIZE)
    .width(Const.FULL_SIZE)
  }
}